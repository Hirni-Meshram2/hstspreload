"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.2.1"
__checksum__ = "22f622148b9c8e1808a42f6e5ef4707d31f74bc1e39687eafcbc1fd6340f46c8"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 57), (82, 26), (108, 12), None, (120, 19), (139, 22), (161, 7), (168, 20), (188, 18), None, (206, 29), (235, 45), (280, 7), (287, 9), (296, 36), (332, 10), (342, 10), (352, 28), None, (380, 54), (434, 8), (442, 18), (460, 19), (479, 13), (492, 14), (506, 14), None, None, (520, 29), (549, 20), (569, 35), (604, 14), (618, 24), (642, 9), None, (651, 25), (676, 27), (703, 8), (711, 13), None, None, (724, 17), (741, 6), (747, 26), (773, 5), (778, 5), (783, 10), (793, 14), (807, 11), (818, 12), (830, 27), None, (857, 11), (868, 11), (879, 7), (886, 29), (915, 18), (933, 27), (960, 46), (1006, 25), (1031, 16), (1047, 8), (1055, 5), (1060, 22), (1082, 18), None, (1100, 36), (1136, 15), (1151, 8), (1159, 11), None, (1170, 5), (1175, 16), (1191, 14), (1205, 18), None, (1223, 14), (1237, 26), (1263, 48), (1311, 19), (1330, 5), (1335, 46), (1381, 14), (1395, 14), (1409, 20), None, (1429, 10), (1439, 13), (1452, 15), (1467, 19), None, (1486, 13), (1499, 19), (1518, 11), (1529, 4), (1533, 22), (1555, 10), (1565, 7), (1572, 14), (1586, 21), (1607, 11), (1618, 21), (1639, 12), (1651, 32), None, (1683, 10), (1693, 14), (1707, 12), (1719, 45), (1764, 15), None, (1779, 11), (1790, 23), (1813, 21), (1834, 26), (1860, 6), (1866, 6), (1872, 7), (1879, 5), (1884, 20), (1904, 23), (1927, 24), (1951, 13), (1964, 15), (1979, 19), (1998, 6), (2004, 61), (2065, 44), (2109, 12), (2121, 23), (2144, 16), (2160, 38), (2198, 6), (2204, 12), (2216, 44), (2260, 6), (2266, 41), (2307, 13), (2320, 23), (2343, 30), (2373, 16), (2389, 8), (2397, 15), (2412, 12), (2424, 19), (2443, 21), (2464, 15), None, (2479, 35), (2514, 21), (2535, 17), (2552, 19), (2571, 26), (2597, 5), (2602, 37), (2639, 26), (2665, 16), (2681, 10), (2691, 17), (2708, 23), (2731, 14), (2745, 17), (2762, 8), (2770, 4), (2774, 7), (2781, 29), (2810, 6), (2816, 18), (2834, 27), (2861, 20), (2881, 17), (2898, 19), (2917, 12), (2929, 40), (2969, 40), (3009, 12), (3021, 48), (3069, 25), (3094, 12), None, (3106, 8), (3114, 25), (3139, 19), (3158, 6), (3164, 23), None, (3187, 30), (3217, 33), (3250, 14), (3264, 12), (3276, 27), None, (3303, 26), (3329, 41), (3370, 50), (3420, 15), (3435, 20), (3455, 15), (3470, 21), (3491, 32), (3523, 24), (3547, 20), (3567, 17), (3584, 60), (3644, 19), (3663, 9), (3672, 12), (3684, 12), (3696, 11), (3707, 10), (3717, 48), (3765, 32), None, (3797, 25), (3822, 12), None, (3834, 8), (3842, 8), (3850, 7), None, (3857, 25), (3882, 17), None, (3899, 21), (3920, 35), (3955, 12), (3967, 10), (3977, 36), (4013, 20), (4033, 22), (4055, 23), (4078, 19), (4097, 12), (4109, 5), (4114, 30), (4144, 24), (4168, 14), (4182, 14), (4196, 47), (4243, 46), None, None, (4289, 51), (4340, 42), None, (4382, 14), None, (4396, 15), (4411, 8), (4419, 21), (4440, 6), (4446, 16), (4462, 17)], [(4479, 7085), (11564, 7597), (19161, 7756), (26917, 6753), (33670, 7202), (40872, 6860), (47732, 7777), (55509, 6772), (62281, 7637), (69918, 6801), (76719, 8073), (84792, 7140), (91932, 7334), (99266, 8304), (107570, 7255), (114825, 7457), (122282, 7890), (130172, 6536), (136708, 7072), (143780, 7147), (150927, 7625), (158552, 7356), (165908, 7750), (173658, 6820), (180478, 7331), (187809, 7258), (195067, 7709), (202776, 7830), (210606, 7145), (217751, 7367), (225118, 7704), (232822, 7212), (240034, 7299), (247333, 7743), (255076, 6878), (261954, 7442), (269396, 6981), (276377, 7935), (284312, 7505), (291817, 7675), (299492, 8136), (307628, 7074), (314702, 7167), (321869, 6901), (328770, 7041), (335811, 7055), (342866, 7309), (350175, 8032), (358207, 6985), (365192, 6746), (371938, 7066), (379004, 7560), (386564, 7514), (394078, 7680), (401758, 7830), (409588, 7601), (417189, 7571), (424760, 6981), (431741, 7812), (439553, 6524), (446077, 7386), (453463, 7194), (460657, 7169), (467826, 7822), (475648, 7751), (483399, 7624), (491023, 7093), (498116, 7983), (506099, 7667), (513766, 7494), (521260, 7127), (528387, 7207), (535594, 6617), (542211, 7735), (549946, 7701), (557647, 8118), (565765, 6818), (572583, 7996), (580579, 7819), (588398, 6814), (595212, 7651), (602863, 6498), (609361, 7251), (616612, 7516), (624128, 7077), (631205, 7150), (638355, 7640), (645995, 7433), (653428, 7651), (661079, 7557), (668636, 8209), (676845, 6652), (683497, 7070), (690567, 7280), (697847, 7529), (705376, 7872), (713248, 7912), (721160, 7097), (728257, 7142), (735399, 7038), (742437, 7090), (749527, 7481), (757008, 7292), (764300, 7204), (771504, 7021), (778525, 7799), (786324, 7630), (793954, 7748), (801702, 8724), (810426, 7830), (818256, 7637), (825893, 7462), (833355, 7209), (840564, 7359), (847923, 7698), (855621, 7557), (863178, 7055), (870233, 7136), (877369, 7166), (884535, 7882), (892417, 7808), (900225, 7688), (907913, 7706), (915619, 7740), (923359, 8648), (932007, 7182), (939189, 6734), (945923, 7842), (953765, 7386), (961151, 8891), (970042, 8022), (978064, 6906), (984970, 7698), (992668, 7641), (1000309, 7050), (1007359, 7819), (1015178, 6980), (1022158, 7528), (1029686, 7223), (1036909, 7300), (1044209, 7543), (1051752, 7836), (1059588, 6922), (1066510, 7310), (1073820, 7415), (1081235, 7277), (1088512, 7219), (1095731, 7427), (1103158, 7048), (1110206, 7899), (1118105, 7349), (1125454, 7679), (1133133, 7721), (1140854, 7131), (1147985, 7489), (1155474, 7382), (1162856, 7342), (1170198, 7368), (1177566, 7066), (1184632, 6799), (1191431, 6930), (1198361, 7677), (1206038, 8141), (1214179, 6925), (1221104, 7265), (1228369, 7859), (1236228, 7314), (1243542, 7084), (1250626, 7769), (1258395, 7349), (1265744, 6506), (1272250, 7364), (1279614, 8687), (1288301, 6857), (1295158, 7128), (1302286, 7622), (1309908, 7397), (1317305, 7373), (1324678, 7214), (1331892, 6827), (1338719, 8249), (1346968, 7573), (1354541, 7229), (1361770, 7840), (1369610, 8413), (1378023, 8077), (1386100, 6789), (1392889, 7737), (1400626, 7159), (1407785, 7510), (1415295, 8007), (1423302, 7062), (1430364, 7676), (1438040, 7823), (1445863, 7328), (1453191, 7365), (1460556, 7208), (1467764, 7324), (1475088, 7326), (1482414, 7113), (1489527, 7736), (1497263, 6851), (1504114, 7820), (1511934, 7545), (1519479, 7944), (1527423, 7698), (1535121, 6464), (1541585, 7465), (1549050, 7215), (1556265, 7612), (1563877, 7633), (1571510, 7765), (1579275, 7421), (1586696, 7921), (1594617, 7563), (1602180, 7307), (1609487, 7322), (1616809, 7304), (1624113, 7470), (1631583, 7420), (1639003, 7536), (1646539, 6777), (1653316, 8332), (1661648, 7413), (1669061, 7065), (1676126, 7343), (1683469, 7421), (1690890, 6856), (1697746, 7554), (1705300, 7384), (1712684, 8197), (1720881, 7459), (1728340, 7126), (1735466, 7611), (1743077, 7174), (1750251, 8111), (1758362, 7150), (1765512, 6954), (1772466, 6318), (1778784, 7898), (1786682, 7361), (1794043, 7661), (1801704, 7108), (1808812, 7325), (1816137, 7270), (1823407, 7816), (1831223, 7153), (1838376, 6586), (1844962, 7382), (1852344, 6852), (1859196, 7525), (1866721, 7768), (1874489, 7829), (1882318, 6936), (1889254, 7243), (1896497, 7296)], [(1903793, 831), (1904624, 715), (1905339, 688), (1906027, 896), (1906923, 638), (1907561, 715), (1908276, 671), (1908947, 910), (1909857, 721), (1910578, 717), (1911295, 580), (1911875, 642), (1912517, 792), (1913309, 885), (1914194, 1022), (1915216, 877), (1916093, 1270), (1917363, 686), (1918049, 971), (1919020, 804), (1919824, 766), (1920590, 810), (1921400, 946), (1922346, 718), (1923064, 776), (1923840, 715), (1924555, 1050), (1925605, 1266), (1926871, 780), (1927651, 850), (1928501, 1037), (1929538, 862), (1930400, 693), (1931093, 738), (1931831, 807), (1932638, 867), (1933505, 765), (1934270, 794), (1935064, 757), (1935821, 1133), (1936954, 695), (1937649, 810), (1938459, 813), (1939272, 753), (1940025, 780), (1940805, 473), (1941278, 1029), (1942307, 968), (1943275, 823), (1944098, 553), (1944651, 853), (1945504, 692), (1946196, 762), (1946958, 1048), (1948006, 1016), (1949022, 572), (1949594, 702), (1950296, 665), (1950961, 666), (1951627, 888), (1952515, 833), (1953348, 832), (1954180, 1073), (1955253, 995), (1956248, 819), (1957067, 758), (1957825, 804), (1958629, 472), (1959101, 667), (1959768, 620), (1960388, 771), (1961159, 955), (1962114, 652), (1962766, 791), (1963557, 650), (1964207, 745), (1964952, 688), (1965640, 710), (1966350, 828), (1967178, 526), (1967704, 863), (1968567, 687), (1969254, 874), (1970128, 700), (1970828, 673), (1971501, 480), (1971981, 657), (1972638, 801), (1973439, 885), (1974324, 802), (1975126, 924), (1976050, 1166), (1977216, 903), (1978119, 941), (1979060, 806), (1979866, 476), (1980342, 979), (1981321, 871), (1982192, 606), (1982798, 738), (1983536, 717), (1984253, 922), (1985175, 947), (1986122, 571), (1986693, 632), (1987325, 844), (1988169, 507), (1988676, 500), (1989176, 1028), (1990204, 1029), (1991233, 820), (1992053, 797), (1992850, 754), (1993604, 804), (1994408, 725), (1995133, 732), (1995865, 696), (1996561, 578), (1997139, 770), (1997909, 689), (1998598, 1026), (1999624, 756), (2000380, 830), (2001210, 502), (2001712, 691), (2002403, 828), (2003231, 880), (2004111, 944), (2005055, 782), (2005837, 990), (2006827, 843), (2007670, 594), (2008264, 910), (2009174, 733), (2009907, 879), (2010786, 795), (2011581, 736), (2012317, 725), (2013042, 701), (2013743, 644), (2014387, 686), (2015073, 701), (2015774, 809), (2016583, 614), (2017197, 534), (2017731, 603), (2018334, 676), (2019010, 666), (2019676, 785), (2020461, 688), (2021149, 808), (2021957, 566), (2022523, 566), (2023089, 750), (2023839, 742), (2024581, 692), (2025273, 751), (2026024, 975), (2026999, 699), (2027698, 576), (2028274, 1044), (2029318, 913), (2030231, 620), (2030851, 750), (2031601, 872), (2032473, 714), (2033187, 707), (2033894, 566), (2034460, 690), (2035150, 749), (2035899, 830), (2036729, 670), (2037399, 932), (2038331, 804), (2039135, 879), (2040014, 796), (2040810, 707), (2041517, 630), (2042147, 773), (2042920, 739), (2043659, 1464), (2045123, 577), (2045700, 712), (2046412, 717), (2047129, 1027), (2048156, 837), (2048993, 848), (2049841, 639), (2050480, 644), (2051124, 904), (2052028, 623), (2052651, 603), (2053254, 831), (2054085, 743), (2054828, 937), (2055765, 849), (2056614, 761), (2057375, 764), (2058139, 883), (2059022, 690), (2059712, 977), (2060689, 680), (2061369, 863), (2062232, 618), (2062850, 824), (2063674, 591), (2064265, 863), (2065128, 843), (2065971, 724), (2066695, 963), (2067658, 761), (2068419, 860), (2069279, 981), (2070260, 1115), (2071375, 922), (2072297, 726), (2073023, 1020), (2074043, 772), (2074815, 589), (2075404, 476), (2075880, 860), (2076740, 806), (2077546, 525), (2078071, 1064), (2079135, 582), (2079717, 798), (2080515, 924), (2081439, 878), (2082317, 872), (2083189, 733), (2083922, 840), (2084762, 783), (2085545, 865), (2086410, 619), (2087029, 665), (2087694, 499), (2088193, 722), (2088915, 465), (2089380, 819), (2090199, 889), (2091088, 881), (2091969, 718), (2092687, 675), (2093362, 604), (2093966, 965), (2094931, 523), (2095454, 629), (2096083, 848), (2096931, 535), (2097466, 923), (2098389, 2131), (2100520, 677), (2101197, 726), (2101923, 938), (2102861, 1072), (2103933, 557)], [(2104490, 48), None, (2104538, 35), (2104573, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2104615, 42), None, (2104657, 25), (2104682, 44), (2104726, 22), (2104748, 18), None, None, None, None, (2104766, 26), None, None, None, None, (2104792, 21), (2104813, 25), None, None, (2104838, 26), None, None, None, None, (2104864, 44), (2104908, 21), (2104929, 23), None, None, None, None, (2104952, 48), None, None, None, None, None, (2105000, 31), None, None, None, None, (2105031, 42), None, (2105073, 22), None, (2105095, 21), None, (2105116, 26), (2105142, 42), None, None, (2105184, 77), None, None, None, None, None, (2105261, 21), (2105282, 21), None, None, (2105303, 34), (2105337, 42), None, None, None, (2105379, 25), None, None, (2105404, 21), None, None, None, None, None, (2105425, 24), (2105449, 21), None, None, (2105470, 26), None, (2105496, 18), None, (2105514, 54), None, None, None, None, None, None, (2105568, 26), None, (2105594, 19), None, (2105613, 20), None, None, (2105633, 42), (2105675, 42), (2105717, 17), (2105734, 17), (2105751, 26), None, (2105777, 26), None, None, None, (2105803, 26), (2105829, 20), (2105849, 26), None, (2105875, 42), (2105917, 63), None, None, None, (2105980, 40), (2106020, 48), None, None, None, (2106068, 47), None, None, None, None, None, None, None, (2106115, 42), None, (2106157, 55), None, (2106212, 9), None, (2106221, 21), (2106242, 42), None, None, (2106284, 65), (2106349, 82), None, None, (2106431, 42), None, None, None, None, None, None, None, None, None, (2106473, 42), (2106515, 21), (2106536, 21), None, (2106557, 42), (2106599, 25), None, (2106624, 16), (2106640, 21), (2106661, 56), None, None, (2106717, 21), (2106738, 19), (2106757, 26), None, (2106783, 16), None, (2106799, 21), None, None, (2106820, 38), None, (2106858, 22), (2106880, 21), (2106901, 21), None, None, (2106922, 63), None, (2106985, 21), (2107006, 42), None, (2107048, 17), None, None, None, None, (2107065, 21), (2107086, 21), None, None, (2107107, 21), None, None, (2107128, 21), None, (2107149, 26), None, (2107175, 50), None, None, None, (2107225, 50), (2107275, 26), (2107301, 21), (2107322, 21), (2107343, 19), None, (2107362, 35), (2107397, 26), (2107423, 23), (2107446, 39), (2107485, 42), None, None, None, None, None, None, (2107527, 21), None, None, None, (2107548, 21), None, None, (2107569, 90), None, (2107659, 239), (2107898, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
