"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.3.8"
__checksum__ = "eb7b659bb968b38885d61dddbfa839a1d12068bf7c7ecfb9d6b72787711b10c3"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 46), (1385, 14), (1399, 14), (1413, 20), None, (1433, 10), (1443, 13), (1456, 15), (1471, 19), None, (1490, 13), (1503, 19), (1522, 11), (1533, 4), (1537, 22), (1559, 10), (1569, 7), (1576, 14), (1590, 21), (1611, 11), (1622, 21), (1643, 12), (1655, 32), None, (1687, 10), (1697, 14), (1711, 12), (1723, 45), (1768, 15), None, (1783, 11), (1794, 23), (1817, 21), (1838, 26), (1864, 6), (1870, 6), (1876, 7), (1883, 5), (1888, 20), (1908, 23), (1931, 24), (1955, 13), (1968, 15), (1983, 19), (2002, 6), (2008, 61), (2069, 44), (2113, 12), (2125, 23), (2148, 16), (2164, 38), (2202, 6), (2208, 12), (2220, 44), (2264, 6), (2270, 41), (2311, 13), (2324, 23), (2347, 30), (2377, 16), (2393, 8), (2401, 15), (2416, 12), (2428, 19), (2447, 21), (2468, 15), None, (2483, 35), (2518, 21), (2539, 17), (2556, 19), (2575, 26), (2601, 5), (2606, 37), (2643, 26), (2669, 16), (2685, 10), (2695, 17), (2712, 23), (2735, 14), (2749, 17), (2766, 8), (2774, 4), (2778, 7), (2785, 29), (2814, 6), (2820, 18), (2838, 27), (2865, 20), (2885, 17), (2902, 19), (2921, 12), (2933, 40), (2973, 40), (3013, 12), (3025, 48), (3073, 25), (3098, 12), None, (3110, 8), (3118, 25), (3143, 19), (3162, 6), (3168, 23), None, (3191, 30), (3221, 33), (3254, 14), (3268, 12), (3280, 27), None, (3307, 26), (3333, 41), (3374, 50), (3424, 15), (3439, 20), (3459, 15), (3474, 21), (3495, 32), (3527, 24), (3551, 20), (3571, 17), (3588, 60), (3648, 19), (3667, 9), (3676, 12), (3688, 12), (3700, 11), (3711, 10), (3721, 48), (3769, 32), None, (3801, 25), (3826, 12), None, (3838, 8), (3846, 8), (3854, 7), None, (3861, 25), (3886, 17), None, (3903, 21), (3924, 35), (3959, 12), (3971, 10), (3981, 36), (4017, 20), (4037, 22), (4059, 23), (4082, 19), (4101, 12), (4113, 5), (4118, 30), (4148, 24), (4172, 14), (4186, 14), (4200, 47), (4247, 46), None, None, (4293, 51), (4344, 42), None, (4386, 14), None, (4400, 15), (4415, 8), (4423, 21), (4444, 6), (4450, 16), (4466, 17)], [(4483, 7274), (11757, 7738), (19495, 8043), (27538, 6999), (34537, 7401), (41938, 6973), (48911, 7975), (56886, 6961), (63847, 7815), (71662, 7180), (78842, 8358), (87200, 7250), (94450, 7631), (102081, 8719), (110800, 7466), (118266, 7694), (125960, 8118), (134078, 6867), (140945, 7283), (148228, 7260), (155488, 7850), (163338, 7647), (170985, 7955), (178940, 6992), (185932, 7533), (193465, 7410), (200875, 7988), (208863, 8017), (216880, 7407), (224287, 7423), (231710, 7910), (239620, 7470), (247090, 7465), (254555, 7845), (262400, 7040), (269440, 7632), (277072, 7308), (284380, 8116), (292496, 7774), (300270, 7835), (308105, 8330), (316435, 7344), (323779, 7366), (331145, 7166), (338311, 7353), (345664, 7317), (352981, 7567), (360548, 8363), (368911, 7379), (376290, 6958), (383248, 7253), (390501, 7668), (398169, 7816), (405985, 7890), (413875, 8135), (422010, 7682), (429692, 7819), (437511, 7463), (444974, 8056), (453030, 6691), (459721, 7475), (467196, 7570), (474766, 7423), (482189, 8092), (490281, 8029), (498310, 7919), (506229, 7219), (513448, 8200), (521648, 7835), (529483, 7663), (537146, 7353), (544499, 7322), (551821, 6880), (558701, 7988), (566689, 7929), (574618, 8337), (582955, 7119), (590074, 8291), (598365, 7984), (606349, 7023), (613372, 7888), (621260, 6710), (627970, 7569), (635539, 7742), (643281, 7160), (650441, 7430), (657871, 7933), (665804, 7749), (673553, 7880), (681433, 7782), (689215, 8469), (697684, 6916), (704600, 7383), (711983, 7565), (719548, 7785), (727333, 8189), (735522, 8117), (743639, 7312), (750951, 7330), (758281, 7335), (765616, 7326), (772942, 7715), (780657, 7510), (788167, 7307), (795474, 7133), (802607, 8043), (810650, 7985), (818635, 7932), (826567, 8891), (835458, 8009), (843467, 7795), (851262, 7775), (859037, 7402), (866439, 7480), (873919, 7862), (881781, 7713), (889494, 7322), (896816, 7295), (904111, 7359), (911470, 8341), (919811, 8014), (927825, 7929), (935754, 7870), (943624, 8004), (951628, 8839), (960467, 7452), (967919, 6919), (974838, 8065), (982903, 7587), (990490, 9293), (999783, 8190), (1007973, 7186), (1015159, 7882), (1023041, 7841), (1030882, 7233), (1038115, 8005), (1046120, 7321), (1053441, 7788), (1061229, 7486), (1068715, 7637), (1076352, 7715), (1084067, 8034), (1092101, 7106), (1099207, 7445), (1106652, 7673), (1114325, 7374), (1121699, 7418), (1129117, 7550), (1136667, 7204), (1143871, 8183), (1152054, 7712), (1159766, 7810), (1167576, 7925), (1175501, 7353), (1182854, 7742), (1190596, 7646), (1198242, 7517), (1205759, 7609), (1213368, 7338), (1220706, 6972), (1227678, 7146), (1234824, 7902), (1242726, 8331), (1251057, 7259), (1258316, 7483), (1265799, 8170), (1273969, 7481), (1281450, 7172), (1288622, 7900), (1296522, 7597), (1304119, 6764), (1310883, 7655), (1318538, 8910), (1327448, 7031), (1334479, 7185), (1341664, 7855), (1349519, 7523), (1357042, 7607), (1364649, 7352), (1372001, 7110), (1379111, 8518), (1387629, 7948), (1395577, 7516), (1403093, 8063), (1411156, 8638), (1419794, 8268), (1428062, 7070), (1435132, 8001), (1443133, 7350), (1450483, 7617), (1458100, 8247), (1466347, 7328), (1473675, 7897), (1481572, 7929), (1489501, 7476), (1496977, 7551), (1504528, 7330), (1511858, 7726), (1519584, 7522), (1527106, 7293), (1534399, 7865), (1542264, 7082), (1549346, 8040), (1557386, 7754), (1565140, 8177), (1573317, 7946), (1581263, 6674), (1587937, 7643), (1595580, 7445), (1603025, 7834), (1610859, 7903), (1618762, 7997), (1626759, 7630), (1634389, 8061), (1642450, 7823), (1650273, 7466), (1657739, 7643), (1665382, 7498), (1672880, 7746), (1680626, 7793), (1688419, 7709), (1696128, 6977), (1703105, 8581), (1711686, 7651), (1719337, 7274), (1726611, 7611), (1734222, 7662), (1741884, 7048), (1748932, 7807), (1756739, 7630), (1764369, 8321), (1772690, 7840), (1780530, 7344), (1787874, 7904), (1795778, 7633), (1803411, 8403), (1811814, 7261), (1819075, 7228), (1826303, 6572), (1832875, 8027), (1840902, 7660), (1848562, 7967), (1856529, 7444), (1863973, 7735), (1871708, 7466), (1879174, 8065), (1887239, 7436), (1894675, 6826), (1901501, 7547), (1909048, 7149), (1916197, 7723), (1923920, 8008), (1931928, 8043), (1939971, 7304), (1947275, 7461), (1954736, 7625)], [(1962361, 898), (1963259, 715), (1963974, 733), (1964707, 918), (1965625, 638), (1966263, 728), (1966991, 671), (1967662, 930), (1968592, 721), (1969313, 729), (1970042, 580), (1970622, 660), (1971282, 792), (1972074, 885), (1972959, 1022), (1973981, 877), (1974858, 1320), (1976178, 722), (1976900, 939), (1977839, 836), (1978675, 766), (1979441, 828), (1980269, 946), (1981215, 730), (1981945, 799), (1982744, 715), (1983459, 1050), (1984509, 1266), (1985775, 797), (1986572, 850), (1987422, 1037), (1988459, 880), (1989339, 693), (1990032, 756), (1990788, 848), (1991636, 867), (1992503, 798), (1993301, 820), (1994121, 757), (1994878, 1087), (1995965, 713), (1996678, 848), (1997526, 831), (1998357, 784), (1999141, 780), (1999921, 522), (2000443, 1073), (2001516, 1010), (2002526, 823), (2003349, 596), (2003945, 882), (2004827, 706), (2005533, 762), (2006295, 1065), (2007360, 1046), (2008406, 572), (2008978, 702), (2009680, 680), (2010360, 683), (2011043, 888), (2011931, 833), (2012764, 832), (2013596, 1125), (2014721, 1021), (2015742, 819), (2016561, 772), (2017333, 770), (2018103, 472), (2018575, 679), (2019254, 620), (2019874, 790), (2020664, 969), (2021633, 652), (2022285, 791), (2023076, 664), (2023740, 725), (2024465, 705), (2025170, 725), (2025895, 843), (2026738, 526), (2027264, 863), (2028127, 687), (2028814, 915), (2029729, 700), (2030429, 707), (2031136, 482), (2031618, 669), (2032287, 801), (2033088, 885), (2033973, 809), (2034782, 966), (2035748, 1183), (2036931, 903), (2037834, 941), (2038775, 786), (2039561, 476), (2040037, 996), (2041033, 871), (2041904, 606), (2042510, 721), (2043231, 800), (2044031, 922), (2044953, 966), (2045919, 594), (2046513, 652), (2047165, 885), (2048050, 507), (2048557, 541), (2049098, 1028), (2050126, 1045), (2051171, 802), (2051973, 825), (2052798, 803), (2053601, 804), (2054405, 751), (2055156, 732), (2055888, 696), (2056584, 578), (2057162, 787), (2057949, 707), (2058656, 1078), (2059734, 772), (2060506, 847), (2061353, 502), (2061855, 736), (2062591, 853), (2063444, 880), (2064324, 998), (2065322, 782), (2066104, 990), (2067094, 873), (2067967, 616), (2068583, 915), (2069498, 733), (2070231, 879), (2071110, 795), (2071905, 736), (2072641, 725), (2073366, 701), (2074067, 670), (2074737, 706), (2075443, 701), (2076144, 804), (2076948, 651), (2077599, 562), (2078161, 603), (2078764, 696), (2079460, 650), (2080110, 767), (2080877, 688), (2081565, 823), (2082388, 602), (2082990, 644), (2083634, 772), (2084406, 723), (2085129, 713), (2085842, 784), (2086626, 988), (2087614, 743), (2088357, 591), (2088948, 1044), (2089992, 927), (2090919, 696), (2091615, 765), (2092380, 902), (2093282, 736), (2094018, 745), (2094763, 623), (2095386, 711), (2096097, 749), (2096846, 830), (2097676, 712), (2098388, 950), (2099338, 819), (2100157, 904), (2101061, 814), (2101875, 737), (2102612, 630), (2103242, 790), (2104032, 762), (2104794, 1533), (2106327, 594), (2106921, 806), (2107727, 710), (2108437, 1012), (2109449, 849), (2110298, 870), (2111168, 653), (2111821, 674), (2112495, 913), (2113408, 623), (2114031, 603), (2114634, 873), (2115507, 784), (2116291, 948), (2117239, 825), (2118064, 779), (2118843, 781), (2119624, 899), (2120523, 690), (2121213, 977), (2122190, 680), (2122870, 879), (2123749, 618), (2124367, 806), (2125173, 610), (2125783, 904), (2126687, 872), (2127559, 748), (2128307, 989), (2129296, 761), (2130057, 890), (2130947, 999), (2131946, 1115), (2133061, 938), (2133999, 726), (2134725, 1020), (2135745, 813), (2136558, 589), (2137147, 495), (2137642, 878), (2138520, 794), (2139314, 525), (2139839, 1083), (2140922, 574), (2141496, 798), (2142294, 938), (2143232, 916), (2144148, 927), (2145075, 733), (2145808, 888), (2146696, 763), (2147459, 898), (2148357, 619), (2148976, 685), (2149661, 519), (2150180, 703), (2150883, 469), (2151352, 851), (2152203, 931), (2153134, 881), (2154015, 718), (2154733, 675), (2155408, 617), (2156025, 982), (2157007, 523), (2157530, 638), (2158168, 915), (2159083, 519), (2159602, 946), (2160548, 2131), (2162679, 697), (2163376, 749), (2164125, 975), (2165100, 1094), (2166194, 499)], [(2166693, 48), None, (2166741, 35), (2166776, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2166818, 42), None, (2166860, 25), (2166885, 44), (2166929, 22), (2166951, 18), None, None, None, None, (2166969, 26), None, None, None, None, (2166995, 21), (2167016, 25), None, None, (2167041, 26), None, None, None, None, (2167067, 44), (2167111, 21), (2167132, 23), None, None, None, None, (2167155, 48), None, None, None, None, None, (2167203, 31), None, None, None, None, (2167234, 42), None, (2167276, 22), None, (2167298, 21), None, (2167319, 26), (2167345, 42), None, None, (2167387, 77), None, None, None, None, None, (2167464, 21), (2167485, 21), None, None, (2167506, 34), (2167540, 42), None, None, None, (2167582, 25), None, None, (2167607, 21), None, None, None, None, None, (2167628, 24), (2167652, 21), None, None, (2167673, 26), None, (2167699, 18), None, (2167717, 54), None, None, None, None, None, None, (2167771, 26), None, None, None, (2167797, 20), None, None, (2167817, 42), (2167859, 42), (2167901, 17), (2167918, 17), (2167935, 26), None, (2167961, 26), None, None, None, (2167987, 26), (2168013, 20), (2168033, 26), None, (2168059, 42), (2168101, 63), None, None, None, (2168164, 40), (2168204, 48), None, None, None, (2168252, 47), None, None, None, None, None, None, None, (2168299, 42), None, (2168341, 55), None, (2168396, 9), None, (2168405, 21), (2168426, 42), None, None, (2168468, 65), (2168533, 82), None, None, (2168615, 42), None, None, None, (2168657, 21), None, None, None, None, None, (2168678, 42), (2168720, 21), (2168741, 21), None, (2168762, 42), (2168804, 25), None, (2168829, 16), (2168845, 21), (2168866, 56), None, None, (2168922, 21), (2168943, 19), (2168962, 26), None, (2168988, 16), None, (2169004, 21), None, None, (2169025, 38), None, (2169063, 22), (2169085, 21), (2169106, 21), (2169127, 21), None, (2169148, 63), None, (2169211, 21), (2169232, 42), None, (2169274, 17), None, None, None, None, (2169291, 21), (2169312, 21), None, None, (2169333, 21), None, None, (2169354, 21), None, (2169375, 26), None, (2169401, 50), None, None, None, (2169451, 50), (2169501, 26), (2169527, 21), (2169548, 21), (2169569, 19), None, (2169588, 35), (2169623, 26), (2169649, 23), (2169672, 39), (2169711, 42), None, None, None, None, None, None, (2169753, 21), None, None, None, (2169774, 21), None, None, (2169795, 90), None, (2169885, 239), (2170124, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
