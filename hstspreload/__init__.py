"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.1.11"
__checksum__ = "773b67be8a92cca1a884dd68439e1e163aad76401deb821521128541e9df493b"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 57), (82, 26), (108, 12), None, (120, 19), (139, 22), (161, 7), (168, 20), (188, 18), None, (206, 29), (235, 45), (280, 7), (287, 9), (296, 36), (332, 10), (342, 10), (352, 28), None, (380, 54), (434, 8), (442, 18), (460, 19), (479, 13), (492, 14), (506, 14), None, None, (520, 29), (549, 20), (569, 35), (604, 14), (618, 24), (642, 9), None, (651, 25), (676, 27), (703, 8), (711, 13), (724, 10), None, (734, 17), (751, 6), (757, 26), (783, 5), (788, 5), (793, 10), (803, 14), (817, 11), (828, 12), (840, 27), None, (867, 11), (878, 11), (889, 7), (896, 29), (925, 18), (943, 27), (970, 46), (1016, 25), (1041, 16), (1057, 8), (1065, 5), (1070, 22), (1092, 18), None, (1110, 36), (1146, 15), (1161, 8), (1169, 11), None, (1180, 5), (1185, 16), (1201, 14), (1215, 18), None, (1233, 14), (1247, 26), (1273, 48), (1321, 19), (1340, 5), (1345, 46), (1391, 14), (1405, 14), (1419, 20), None, (1439, 10), (1449, 13), (1462, 15), (1477, 19), None, (1496, 13), (1509, 19), (1528, 11), (1539, 4), (1543, 22), (1565, 10), (1575, 7), (1582, 14), (1596, 21), (1617, 11), (1628, 21), (1649, 12), (1661, 32), None, (1693, 10), (1703, 14), (1717, 12), (1729, 45), (1774, 15), None, (1789, 11), (1800, 23), (1823, 21), (1844, 26), (1870, 6), (1876, 6), (1882, 7), (1889, 5), (1894, 20), (1914, 23), (1937, 24), (1961, 13), (1974, 15), (1989, 19), (2008, 6), (2014, 61), (2075, 44), (2119, 12), (2131, 23), (2154, 16), (2170, 38), (2208, 6), (2214, 12), (2226, 44), (2270, 6), (2276, 41), (2317, 13), (2330, 23), (2353, 30), (2383, 16), (2399, 8), (2407, 15), (2422, 12), (2434, 19), (2453, 21), (2474, 15), None, (2489, 35), (2524, 21), (2545, 17), (2562, 19), (2581, 26), (2607, 5), (2612, 37), (2649, 26), (2675, 16), (2691, 10), (2701, 17), (2718, 23), (2741, 14), (2755, 17), (2772, 8), (2780, 4), (2784, 7), (2791, 29), (2820, 6), (2826, 18), (2844, 27), (2871, 20), (2891, 17), (2908, 19), (2927, 12), (2939, 40), (2979, 40), (3019, 12), (3031, 48), (3079, 25), (3104, 12), None, (3116, 8), (3124, 25), (3149, 19), (3168, 6), (3174, 23), None, (3197, 30), (3227, 33), (3260, 14), (3274, 12), (3286, 27), None, (3313, 26), (3339, 41), (3380, 50), (3430, 15), (3445, 20), (3465, 15), (3480, 21), (3501, 32), (3533, 24), (3557, 20), (3577, 13), (3590, 60), (3650, 19), (3669, 9), (3678, 12), (3690, 12), (3702, 11), (3713, 10), (3723, 48), (3771, 32), None, (3803, 25), (3828, 12), None, (3840, 8), (3848, 8), (3856, 7), None, (3863, 25), (3888, 17), None, (3905, 21), (3926, 35), (3961, 12), (3973, 10), (3983, 36), (4019, 20), (4039, 22), (4061, 23), (4084, 19), (4103, 12), (4115, 5), (4120, 30), (4150, 24), (4174, 14), (4188, 14), (4202, 47), (4249, 46), None, None, (4295, 51), (4346, 42), None, (4388, 14), None, (4402, 15), (4417, 8), (4425, 21), (4446, 6), (4452, 16), (4468, 17)], [(4485, 6880), (11365, 7399), (18764, 7685), (26449, 6656), (33105, 7067), (40172, 6737), (46909, 7549), (54458, 6720), (61178, 7487), (68665, 6569), (75234, 7771), (83005, 6969), (89974, 7102), (97076, 8061), (105137, 7049), (112186, 7273), (119459, 7682), (127141, 6475), (133616, 6862), (140478, 7003), (147481, 7442), (154923, 7124), (162047, 7497), (169544, 6674), (176218, 7156), (183374, 7079), (190453, 7467), (197920, 7647), (205567, 6916), (212483, 7286), (219769, 7522), (227291, 7083), (234374, 7215), (241589, 7495), (249084, 6652), (255736, 7226), (262962, 6917), (269879, 7629), (277508, 7262), (284770, 7454), (292224, 8025), (300249, 6889), (307138, 6982), (314120, 6705), (320825, 6822), (327647, 6926), (334573, 7018), (341591, 7733), (349324, 6917), (356241, 6652), (362893, 6883), (369776, 7260), (377036, 7297), (384333, 7432), (391765, 7729), (399494, 7429), (406923, 7375), (414298, 6795), (421093, 7582), (428675, 6434), (435109, 7229), (442338, 7025), (449363, 7025), (456388, 7643), (464031, 7371), (471402, 7481), (478883, 6890), (485773, 7895), (493668, 7500), (501168, 7343), (508511, 6995), (515506, 7038), (522544, 6351), (528895, 7562), (536457, 7532), (543989, 7937), (551926, 6555), (558481, 7852), (566333, 7718), (574051, 6727), (580778, 7409), (588187, 6273), (594460, 7022), (601482, 7312), (608794, 6909), (615703, 6977), (622680, 7457), (630137, 7258), (637395, 7399), (644794, 7320), (652114, 8117), (660231, 6464), (666695, 6885), (673580, 7061), (680641, 7237), (687878, 7703), (695581, 7640), (703221, 6927), (710148, 6902), (717050, 6790), (723840, 6843), (730683, 7287), (737970, 7036), (745006, 7075), (752081, 6806), (758887, 7533), (766420, 7423), (773843, 7643), (781486, 8590), (790076, 7663), (797739, 7447), (805186, 7216), (812402, 6994), (819396, 7081), (826477, 7504), (833981, 7299), (841280, 6810), (848090, 6861), (854951, 6948), (861899, 7725), (869624, 7571), (877195, 7557), (884752, 7451), (892203, 7606), (899809, 8420), (908229, 6920), (915149, 6463), (921612, 7654), (929266, 7244), (936510, 8765), (945275, 7889), (953164, 6698), (959862, 7499), (967361, 7414), (974775, 6898), (981673, 7506), (989179, 6700), (995879, 7250), (1003129, 7035), (1010164, 7121), (1017285, 7349), (1024634, 7709), (1032343, 6654), (1038997, 7083), (1046080, 7242), (1053322, 7127), (1060449, 7138), (1067587, 7223), (1074810, 6850), (1081660, 7814), (1089474, 7099), (1096573, 7485), (1104058, 7489), (1111547, 7014), (1118561, 7336), (1125897, 7272), (1133169, 7100), (1140269, 7013), (1147282, 6913), (1154195, 6578), (1160773, 6724), (1167497, 7484), (1174981, 7950), (1182931, 6740), (1189671, 7071), (1196742, 7691), (1204433, 7126), (1211559, 6987), (1218546, 7559), (1226105, 7175), (1233280, 6353), (1239633, 7043), (1246676, 8377), (1255053, 6650), (1261703, 6918), (1268621, 7469), (1276090, 7152), (1283242, 7324), (1290566, 7098), (1297664, 6689), (1304353, 8055), (1312408, 7463), (1319871, 7075), (1326946, 7766), (1334712, 8173), (1342885, 7848), (1350733, 6664), (1357397, 7536), (1364933, 6868), (1371801, 7314), (1379115, 7759), (1386874, 6866), (1393740, 7480), (1401220, 7640), (1408860, 7123), (1415983, 7128), (1423111, 7013), (1430124, 7114), (1437238, 7140), (1444378, 6832), (1451210, 7499), (1458709, 6549), (1465258, 7525), (1472783, 7381), (1480164, 7793), (1487957, 7584), (1495541, 6296), (1501837, 7293), (1509130, 7002), (1516132, 7447), (1523579, 7374), (1530953, 7698), (1538651, 7228), (1545879, 7701), (1553580, 7321), (1560901, 7184), (1568085, 7172), (1575257, 7013), (1582270, 7233), (1589503, 7206), (1596709, 7338), (1604047, 6694), (1610741, 8063), (1618804, 7197), (1626001, 6823), (1632824, 7195), (1640019, 7220), (1647239, 6624), (1653863, 7401), (1661264, 7160), (1668424, 8042), (1676466, 7277), (1683743, 6800), (1690543, 7390), (1697933, 6986), (1704919, 7969), (1712888, 6930), (1719818, 6847), (1726665, 6172), (1732837, 7602), (1740439, 7214), (1747653, 7413), (1755066, 6994), (1762060, 7169), (1769229, 6962), (1776191, 7720), (1783911, 6983), (1790894, 6384), (1797278, 7227), (1804505, 6723), (1811228, 7441), (1818669, 7613), (1826282, 7694), (1833976, 6797), (1840773, 6925), (1847698, 7232)], [(1854930, 809), (1855739, 699), (1856438, 688), (1857126, 896), (1858022, 624), (1858646, 715), (1859361, 671), (1860032, 909), (1860941, 705), (1861646, 717), (1862363, 580), (1862943, 657), (1863600, 792), (1864392, 885), (1865277, 1046), (1866323, 852), (1867175, 1231), (1868406, 686), (1869092, 956), (1870048, 787), (1870835, 735), (1871570, 798), (1872368, 946), (1873314, 692), (1874006, 776), (1874782, 715), (1875497, 1007), (1876504, 1248), (1877752, 780), (1878532, 805), (1879337, 979), (1880316, 862), (1881178, 653), (1881831, 738), (1882569, 791), (1883360, 848), (1884208, 724), (1884932, 764), (1885696, 742), (1886438, 1133), (1887571, 695), (1888266, 810), (1889076, 779), (1889855, 753), (1890608, 778), (1891386, 460), (1891846, 994), (1892840, 913), (1893753, 793), (1894546, 553), (1895099, 853), (1895952, 692), (1896644, 762), (1897406, 1012), (1898418, 1032), (1899450, 572), (1900022, 702), (1900724, 586), (1901310, 649), (1901959, 888), (1902847, 815), (1903662, 815), (1904477, 1054), (1905531, 981), (1906512, 792), (1907304, 758), (1908062, 783), (1908845, 472), (1909317, 667), (1909984, 620), (1910604, 756), (1911360, 913), (1912273, 636), (1912909, 791), (1913700, 650), (1914350, 745), (1915095, 663), (1915758, 689), (1916447, 828), (1917275, 496), (1917771, 815), (1918586, 687), (1919273, 874), (1920147, 700), (1920847, 644), (1921491, 451), (1921942, 630), (1922572, 778), (1923350, 871), (1924221, 782), (1925003, 924), (1925927, 1142), (1927069, 859), (1927928, 949), (1928877, 776), (1929653, 476), (1930129, 979), (1931108, 871), (1931979, 606), (1932585, 721), (1933306, 728), (1934034, 922), (1934956, 926), (1935882, 571), (1936453, 632), (1937085, 824), (1937909, 507), (1938416, 500), (1938916, 1010), (1939926, 1029), (1940955, 839), (1941794, 778), (1942572, 721), (1943293, 827), (1944120, 713), (1944833, 715), (1945548, 696), (1946244, 541), (1946785, 721), (1947506, 709), (1948215, 1026), (1949241, 756), (1949997, 830), (1950827, 502), (1951329, 691), (1952020, 810), (1952830, 871), (1953701, 926), (1954627, 782), (1955409, 990), (1956399, 832), (1957231, 573), (1957804, 892), (1958696, 718), (1959414, 849), (1960263, 775), (1961038, 750), (1961788, 725), (1962513, 688), (1963201, 644), (1963845, 670), (1964515, 701), (1965216, 809), (1966025, 614), (1966639, 517), (1967156, 603), (1967759, 676), (1968435, 597), (1969032, 797), (1969829, 688), (1970517, 773), (1971290, 550), (1971840, 550), (1972390, 734), (1973124, 682), (1973806, 677), (1974483, 695), (1975178, 961), (1976139, 699), (1976838, 576), (1977414, 1022), (1978436, 913), (1979349, 605), (1979954, 726), (1980680, 872), (1981552, 714), (1982266, 707), (1982973, 508), (1983481, 690), (1984171, 733), (1984904, 830), (1985734, 670), (1986404, 932), (1987336, 804), (1988140, 863), (1989003, 796), (1989799, 685), (1990484, 616), (1991100, 718), (1991818, 727), (1992545, 1464), (1994009, 560), (1994569, 680), (1995249, 717), (1995966, 1043), (1997009, 834), (1997843, 829), (1998672, 602), (1999274, 609), (1999883, 904), (2000787, 623), (2001410, 603), (2002013, 814), (2002827, 752), (2003579, 937), (2004516, 810), (2005326, 761), (2006087, 764), (2006851, 883), (2007734, 669), (2008403, 977), (2009380, 662), (2010042, 842), (2010884, 618), (2011502, 805), (2012307, 568), (2012875, 863), (2013738, 843), (2014581, 688), (2015269, 963), (2016232, 761), (2016993, 860), (2017853, 960), (2018813, 1092), (2019905, 922), (2020827, 669), (2021496, 983), (2022479, 755), (2023234, 589), (2023823, 492), (2024315, 860), (2025175, 806), (2025981, 484), (2026465, 1059), (2027524, 566), (2028090, 798), (2028888, 924), (2029812, 861), (2030673, 826), (2031499, 722), (2032221, 840), (2033061, 768), (2033829, 865), (2034694, 604), (2035298, 665), (2035963, 499), (2036462, 664), (2037126, 484), (2037610, 799), (2038409, 869), (2039278, 881), (2040159, 718), (2040877, 675), (2041552, 604), (2042156, 965), (2043121, 523), (2043644, 629), (2044273, 848), (2045121, 557), (2045678, 923), (2046601, 2112), (2048713, 638), (2049351, 705), (2050056, 923), (2050979, 1029), (2052008, 557)], [(2052565, 48), None, (2052613, 35), (2052648, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2052690, 42), None, (2052732, 25), (2052757, 44), (2052801, 22), (2052823, 18), None, None, None, None, (2052841, 26), None, None, None, None, (2052867, 21), (2052888, 25), None, None, (2052913, 26), None, None, None, None, (2052939, 44), (2052983, 21), (2053004, 23), None, None, None, None, (2053027, 48), None, None, None, None, None, (2053075, 31), None, None, None, None, (2053106, 42), None, (2053148, 22), None, (2053170, 21), None, (2053191, 26), (2053217, 42), None, None, (2053259, 77), None, None, None, None, None, (2053336, 21), (2053357, 21), None, None, (2053378, 34), (2053412, 42), None, None, None, (2053454, 25), None, None, (2053479, 21), None, None, None, None, None, (2053500, 24), (2053524, 21), None, None, (2053545, 26), None, (2053571, 18), None, (2053589, 54), None, None, None, None, None, None, (2053643, 26), None, (2053669, 19), None, (2053688, 20), None, None, (2053708, 42), (2053750, 42), (2053792, 17), (2053809, 17), (2053826, 26), None, (2053852, 26), None, None, None, (2053878, 26), (2053904, 20), (2053924, 26), None, (2053950, 42), (2053992, 63), None, None, None, (2054055, 40), (2054095, 48), None, None, None, (2054143, 47), None, None, None, None, None, None, None, (2054190, 42), None, (2054232, 55), None, (2054287, 9), None, (2054296, 21), (2054317, 42), None, None, (2054359, 65), (2054424, 82), None, None, (2054506, 42), None, None, None, None, None, None, None, None, None, (2054548, 42), (2054590, 21), (2054611, 21), None, (2054632, 42), (2054674, 25), None, (2054699, 16), (2054715, 21), (2054736, 56), None, None, (2054792, 21), (2054813, 19), (2054832, 26), None, (2054858, 16), None, (2054874, 39), None, None, (2054913, 38), None, (2054951, 22), (2054973, 21), (2054994, 21), None, None, (2055015, 63), None, (2055078, 21), (2055099, 42), None, (2055141, 17), None, None, None, None, (2055158, 21), (2055179, 21), None, None, (2055200, 21), None, None, (2055221, 21), None, (2055242, 26), None, (2055268, 50), None, None, None, (2055318, 50), (2055368, 26), (2055394, 21), (2055415, 21), (2055436, 19), None, (2055455, 35), (2055490, 26), (2055516, 23), (2055539, 21), (2055560, 42), None, None, None, None, None, None, (2055602, 21), None, None, None, (2055623, 21), None, None, (2055644, 90), None, (2055734, 239), (2055973, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
