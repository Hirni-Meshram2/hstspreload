"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.3.22"
__checksum__ = "ae7050600f038ab258c687808566a8fdf9ac0e96ca97e2efe8d6868afb40ccd9"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 46), (1385, 14), (1399, 14), (1413, 20), None, (1433, 10), (1443, 13), (1456, 15), (1471, 19), None, (1490, 13), (1503, 19), (1522, 11), (1533, 4), (1537, 22), (1559, 10), (1569, 7), (1576, 14), (1590, 21), (1611, 11), (1622, 21), (1643, 12), (1655, 32), None, (1687, 10), (1697, 14), (1711, 12), (1723, 45), (1768, 15), None, (1783, 11), (1794, 23), (1817, 21), (1838, 26), (1864, 6), (1870, 6), (1876, 7), (1883, 5), (1888, 20), (1908, 23), (1931, 24), (1955, 13), (1968, 15), (1983, 19), (2002, 6), (2008, 61), (2069, 44), (2113, 12), (2125, 23), (2148, 16), (2164, 38), (2202, 6), (2208, 12), (2220, 44), (2264, 6), (2270, 41), (2311, 13), (2324, 23), (2347, 30), (2377, 16), (2393, 8), (2401, 15), (2416, 12), (2428, 19), (2447, 21), (2468, 15), None, (2483, 35), (2518, 21), (2539, 17), (2556, 19), (2575, 26), (2601, 5), (2606, 37), (2643, 26), (2669, 16), (2685, 10), (2695, 17), (2712, 23), (2735, 14), (2749, 17), (2766, 8), (2774, 4), (2778, 7), (2785, 29), (2814, 6), (2820, 18), (2838, 27), (2865, 20), (2885, 17), (2902, 19), (2921, 12), (2933, 40), (2973, 40), (3013, 12), (3025, 48), (3073, 25), (3098, 12), None, (3110, 8), (3118, 25), (3143, 19), (3162, 6), (3168, 23), None, (3191, 30), (3221, 33), (3254, 14), (3268, 12), (3280, 27), None, (3307, 26), (3333, 41), (3374, 50), (3424, 15), (3439, 20), (3459, 15), (3474, 21), (3495, 32), (3527, 24), (3551, 20), (3571, 17), (3588, 60), (3648, 19), (3667, 9), (3676, 12), (3688, 12), (3700, 11), (3711, 10), (3721, 48), (3769, 32), None, (3801, 25), (3826, 23), None, (3849, 8), (3857, 8), (3865, 7), None, (3872, 25), (3897, 17), None, (3914, 21), (3935, 35), (3970, 21), (3991, 10), (4001, 36), (4037, 20), (4057, 22), (4079, 23), (4102, 19), (4121, 12), (4133, 5), (4138, 30), (4168, 24), (4192, 14), (4206, 14), (4220, 47), (4267, 46), None, None, (4313, 51), (4364, 42), None, (4406, 14), None, (4420, 15), (4435, 8), (4443, 21), (4464, 6), (4470, 16), (4486, 17)], [(4503, 7350), (11853, 7827), (19680, 8091), (27771, 7035), (34806, 7439), (42245, 6999), (49244, 8084), (57328, 7015), (64343, 7905), (72248, 7245), (79493, 8449), (87942, 7278), (95220, 7725), (102945, 8822), (111767, 7507), (119274, 7729), (127003, 8174), (135177, 6974), (142151, 7323), (149474, 7283), (156757, 7862), (164619, 7715), (172334, 8033), (180367, 7095), (187462, 7577), (195039, 7515), (202554, 8006), (210560, 8090), (218650, 7442), (226092, 7487), (233579, 7925), (241504, 7615), (249119, 7554), (256673, 7868), (264541, 7093), (271634, 7634), (279268, 7413), (286681, 8257), (294938, 7864), (302802, 7935), (310737, 8428), (319165, 7349), (326514, 7395), (333909, 7179), (341088, 7354), (348442, 7348), (355790, 7623), (363413, 8360), (371773, 7413), (379186, 6976), (386162, 7263), (393425, 7768), (401193, 7899), (409092, 7911), (417003, 8168), (425171, 7764), (432935, 7942), (440877, 7496), (448373, 8143), (456516, 6716), (463232, 7558), (470790, 7643), (478433, 7465), (485898, 8160), (494058, 8052), (502110, 7992), (510102, 7307), (517409, 8247), (525656, 7933), (533589, 7753), (541342, 7449), (548791, 7332), (556123, 6948), (563071, 8099), (571170, 7928), (579098, 8379), (587477, 7188), (594665, 8335), (603000, 8091), (611091, 7092), (618183, 7981), (626164, 6819), (632983, 7623), (640606, 7791), (648397, 7307), (655704, 7561), (663265, 8034), (671299, 7843), (679142, 7957), (687099, 7870), (694969, 8519), (703488, 6967), (710455, 7449), (717904, 7652), (725556, 7871), (733427, 8281), (741708, 8219), (749927, 7375), (757302, 7401), (764703, 7403), (772106, 7396), (779502, 7703), (787205, 7587), (794792, 7385), (802177, 7242), (809419, 8126), (817545, 8053), (825598, 8043), (833641, 8927), (842568, 8057), (850625, 7822), (858447, 7856), (866303, 7448), (873751, 7500), (881251, 7903), (889154, 7825), (896979, 7407), (904386, 7337), (911723, 7479), (919202, 8385), (927587, 8054), (935641, 8025), (943666, 7894), (951560, 8099), (959659, 8914), (968573, 7504), (976077, 6988), (983065, 8157), (991222, 7708), (998930, 9428), (1008358, 8259), (1016617, 7326), (1023943, 7957), (1031900, 7894), (1039794, 7280), (1047074, 8054), (1055128, 7378), (1062506, 7890), (1070396, 7546), (1077942, 7775), (1085717, 7768), (1093485, 8069), (1101554, 7168), (1108722, 7487), (1116209, 7683), (1123892, 7461), (1131353, 7500), (1138853, 7509), (1146362, 7315), (1153677, 8220), (1161897, 7777), (1169674, 7806), (1177480, 8061), (1185541, 7382), (1192923, 7770), (1200693, 7656), (1208349, 7560), (1215909, 7658), (1223567, 7408), (1230975, 7044), (1238019, 7149), (1245168, 7937), (1253105, 8356), (1261461, 7333), (1268794, 7481), (1276275, 8246), (1284521, 7556), (1292077, 7172), (1299249, 7937), (1307186, 7702), (1314888, 6875), (1321763, 7689), (1329452, 9001), (1338453, 7080), (1345533, 7237), (1352770, 7919), (1360689, 7580), (1368269, 7745), (1376014, 7407), (1383421, 7237), (1390658, 8508), (1399166, 8058), (1407224, 7609), (1414833, 8169), (1423002, 8665), (1431667, 8334), (1440001, 7119), (1447120, 8116), (1455236, 7377), (1462613, 7709), (1470322, 8299), (1478621, 7382), (1486003, 7921), (1493924, 7985), (1501909, 7518), (1509427, 7643), (1517070, 7393), (1524463, 7729), (1532192, 7535), (1539727, 7306), (1547033, 7959), (1554992, 7107), (1562099, 8124), (1570223, 7865), (1578088, 8193), (1586281, 7945), (1594226, 6759), (1600985, 7737), (1608722, 7512), (1616234, 7891), (1624125, 7944), (1632069, 8027), (1640096, 7735), (1647831, 8095), (1655926, 7937), (1663863, 7461), (1671324, 7686), (1679010, 7501), (1686511, 7822), (1694333, 7835), (1702168, 7789), (1709957, 7040), (1716997, 8624), (1725621, 7684), (1733305, 7320), (1740625, 7669), (1748294, 7692), (1755986, 7034), (1763020, 7884), (1770904, 7655), (1778559, 8447), (1787006, 7843), (1794849, 7384), (1802233, 7997), (1810230, 7695), (1817925, 8456), (1826381, 7382), (1833763, 7288), (1841051, 6616), (1847667, 8106), (1855773, 7761), (1863534, 8038), (1871572, 7524), (1879096, 7788), (1886884, 7496), (1894380, 8210), (1902590, 7450), (1910040, 6926), (1916966, 7612), (1924578, 7195), (1931773, 7816), (1939589, 8083), (1947672, 8105), (1955777, 7370), (1963147, 7502), (1970649, 7687)], [(1978336, 933), (1979269, 715), (1979984, 733), (1980717, 918), (1981635, 638), (1982273, 728), (1983001, 671), (1983672, 952), (1984624, 721), (1985345, 729), (1986074, 580), (1986654, 660), (1987314, 792), (1988106, 885), (1988991, 1022), (1990013, 881), (1990894, 1336), (1992230, 722), (1992952, 939), (1993891, 836), (1994727, 766), (1995493, 828), (1996321, 946), (1997267, 765), (1998032, 799), (1998831, 715), (1999546, 1050), (2000596, 1266), (2001862, 797), (2002659, 850), (2003509, 1037), (2004546, 880), (2005426, 693), (2006119, 773), (2006892, 864), (2007756, 848), (2008604, 798), (2009402, 799), (2010201, 777), (2010978, 1087), (2012065, 713), (2012778, 848), (2013626, 831), (2014457, 784), (2015241, 823), (2016064, 522), (2016586, 1073), (2017659, 1010), (2018669, 847), (2019516, 596), (2020112, 882), (2020994, 706), (2021700, 762), (2022462, 1065), (2023527, 1046), (2024573, 572), (2025145, 702), (2025847, 697), (2026544, 683), (2027227, 888), (2028115, 833), (2028948, 832), (2029780, 1149), (2030929, 1038), (2031967, 793), (2032760, 793), (2033553, 770), (2034323, 472), (2034795, 679), (2035474, 633), (2036107, 803), (2036910, 985), (2037895, 675), (2038570, 811), (2039381, 664), (2040045, 737), (2040782, 705), (2041487, 725), (2042212, 843), (2043055, 526), (2043581, 875), (2044456, 724), (2045180, 915), (2046095, 700), (2046795, 719), (2047514, 482), (2047996, 669), (2048665, 817), (2049482, 885), (2050367, 809), (2051176, 998), (2052174, 1183), (2053357, 919), (2054276, 941), (2055217, 799), (2056016, 476), (2056492, 996), (2057488, 871), (2058359, 652), (2059011, 721), (2059732, 800), (2060532, 922), (2061454, 966), (2062420, 619), (2063039, 652), (2063691, 901), (2064592, 507), (2065099, 541), (2065640, 1028), (2066668, 1045), (2067713, 802), (2068515, 825), (2069340, 803), (2070143, 804), (2070947, 767), (2071714, 732), (2072446, 696), (2073142, 597), (2073739, 787), (2074526, 707), (2075233, 1078), (2076311, 772), (2077083, 847), (2077930, 502), (2078432, 736), (2079168, 868), (2080036, 880), (2080916, 1026), (2081942, 782), (2082724, 1006), (2083730, 873), (2084603, 635), (2085238, 915), (2086153, 733), (2086886, 879), (2087765, 795), (2088560, 720), (2089280, 725), (2090005, 719), (2090724, 649), (2091373, 723), (2092096, 701), (2092797, 804), (2093601, 651), (2094252, 562), (2094814, 603), (2095417, 731), (2096148, 650), (2096798, 767), (2097565, 688), (2098253, 823), (2099076, 586), (2099662, 644), (2100306, 772), (2101078, 723), (2101801, 713), (2102514, 784), (2103298, 988), (2104286, 743), (2105029, 614), (2105643, 1044), (2106687, 927), (2107614, 696), (2108310, 765), (2109075, 918), (2109993, 736), (2110729, 745), (2111474, 623), (2112097, 737), (2112834, 749), (2113583, 854), (2114437, 677), (2115114, 950), (2116064, 819), (2116883, 904), (2117787, 833), (2118620, 737), (2119357, 630), (2119987, 813), (2120800, 786), (2121586, 1552), (2123138, 594), (2123732, 806), (2124538, 710), (2125248, 1028), (2126276, 849), (2127125, 870), (2127995, 653), (2128648, 674), (2129322, 913), (2130235, 623), (2130858, 603), (2131461, 873), (2132334, 784), (2133118, 948), (2134066, 825), (2134891, 779), (2135670, 781), (2136451, 899), (2137350, 731), (2138081, 963), (2139044, 715), (2139759, 879), (2140638, 618), (2141256, 806), (2142062, 610), (2142672, 928), (2143600, 914), (2144514, 764), (2145278, 989), (2146267, 761), (2147028, 890), (2147918, 999), (2148917, 1131), (2150048, 952), (2151000, 726), (2151726, 1020), (2152746, 830), (2153576, 589), (2154165, 495), (2154660, 893), (2155553, 794), (2156347, 525), (2156872, 1083), (2157955, 574), (2158529, 798), (2159327, 953), (2160280, 916), (2161196, 927), (2162123, 746), (2162869, 911), (2163780, 763), (2164543, 898), (2165441, 619), (2166060, 700), (2166760, 519), (2167279, 703), (2167982, 469), (2168451, 851), (2169302, 931), (2170233, 881), (2171114, 718), (2171832, 675), (2172507, 617), (2173124, 995), (2174119, 523), (2174642, 638), (2175280, 915), (2176195, 519), (2176714, 932), (2177646, 2131), (2179777, 697), (2180474, 749), (2181223, 975), (2182198, 1094), (2183292, 515)], [(2183807, 48), None, (2183855, 35), (2183890, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2183932, 42), None, (2183974, 25), (2183999, 44), (2184043, 22), (2184065, 18), None, None, None, None, (2184083, 26), None, None, None, None, (2184109, 21), (2184130, 25), None, None, (2184155, 26), None, None, None, None, (2184181, 44), (2184225, 21), (2184246, 23), None, None, None, None, (2184269, 48), None, None, None, None, None, (2184317, 31), None, None, None, None, (2184348, 42), None, (2184390, 22), None, (2184412, 21), None, (2184433, 26), (2184459, 42), None, None, (2184501, 77), None, None, None, None, None, (2184578, 21), (2184599, 21), None, None, (2184620, 34), (2184654, 42), None, None, None, (2184696, 25), None, None, (2184721, 21), None, None, None, None, None, (2184742, 24), (2184766, 21), None, None, (2184787, 26), None, (2184813, 18), None, (2184831, 54), None, None, None, None, None, None, (2184885, 26), None, None, None, (2184911, 20), None, None, (2184931, 42), (2184973, 42), (2185015, 17), (2185032, 17), (2185049, 26), None, (2185075, 26), None, None, None, (2185101, 26), (2185127, 20), (2185147, 26), None, (2185173, 42), (2185215, 63), None, None, None, (2185278, 40), (2185318, 48), None, None, None, (2185366, 47), None, None, None, None, None, None, None, (2185413, 42), None, (2185455, 80), None, (2185535, 9), None, (2185544, 21), (2185565, 42), None, None, (2185607, 65), (2185672, 82), None, None, (2185754, 42), None, None, None, (2185796, 21), None, None, None, None, None, (2185817, 42), (2185859, 21), (2185880, 21), None, (2185901, 42), (2185943, 25), None, (2185968, 16), (2185984, 21), (2186005, 56), None, None, (2186061, 21), (2186082, 19), (2186101, 26), None, (2186127, 16), None, (2186143, 21), None, None, (2186164, 38), None, (2186202, 22), (2186224, 21), (2186245, 21), (2186266, 21), None, (2186287, 63), None, (2186350, 21), (2186371, 42), None, (2186413, 17), None, None, None, None, (2186430, 21), (2186451, 21), None, None, (2186472, 21), None, None, (2186493, 21), None, (2186514, 26), None, (2186540, 50), None, None, None, (2186590, 50), (2186640, 26), (2186666, 21), (2186687, 21), (2186708, 19), None, (2186727, 35), (2186762, 26), (2186788, 23), (2186811, 39), (2186850, 42), None, None, None, None, None, None, (2186892, 21), None, None, None, (2186913, 21), None, None, (2186934, 90), None, (2187024, 239), (2187263, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
