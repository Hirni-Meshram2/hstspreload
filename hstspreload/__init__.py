"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.1.25"
__checksum__ = "9e84abcc86a0c963abc0b76237cdd76d811ee0430833da9e232973eacabb6adb"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 57), (82, 26), (108, 12), None, (120, 19), (139, 22), (161, 7), (168, 20), (188, 18), None, (206, 29), (235, 45), (280, 7), (287, 9), (296, 36), (332, 10), (342, 10), (352, 28), None, (380, 54), (434, 8), (442, 18), (460, 19), (479, 13), (492, 14), (506, 14), None, None, (520, 29), (549, 20), (569, 35), (604, 14), (618, 24), (642, 9), None, (651, 25), (676, 27), (703, 8), (711, 13), None, None, (724, 17), (741, 6), (747, 26), (773, 5), (778, 5), (783, 10), (793, 14), (807, 11), (818, 12), (830, 27), None, (857, 11), (868, 11), (879, 7), (886, 29), (915, 18), (933, 27), (960, 46), (1006, 25), (1031, 16), (1047, 8), (1055, 5), (1060, 22), (1082, 18), None, (1100, 36), (1136, 15), (1151, 8), (1159, 11), None, (1170, 5), (1175, 16), (1191, 14), (1205, 18), None, (1223, 14), (1237, 26), (1263, 48), (1311, 19), (1330, 5), (1335, 46), (1381, 14), (1395, 14), (1409, 20), None, (1429, 10), (1439, 13), (1452, 15), (1467, 19), None, (1486, 13), (1499, 19), (1518, 11), (1529, 4), (1533, 22), (1555, 10), (1565, 7), (1572, 14), (1586, 21), (1607, 11), (1618, 21), (1639, 12), (1651, 32), None, (1683, 10), (1693, 14), (1707, 12), (1719, 45), (1764, 15), None, (1779, 11), (1790, 23), (1813, 21), (1834, 26), (1860, 6), (1866, 6), (1872, 7), (1879, 5), (1884, 20), (1904, 23), (1927, 24), (1951, 13), (1964, 15), (1979, 19), (1998, 6), (2004, 61), (2065, 44), (2109, 12), (2121, 23), (2144, 16), (2160, 38), (2198, 6), (2204, 12), (2216, 44), (2260, 6), (2266, 41), (2307, 13), (2320, 23), (2343, 30), (2373, 16), (2389, 8), (2397, 15), (2412, 12), (2424, 19), (2443, 21), (2464, 15), None, (2479, 35), (2514, 21), (2535, 17), (2552, 19), (2571, 26), (2597, 5), (2602, 37), (2639, 26), (2665, 16), (2681, 10), (2691, 17), (2708, 23), (2731, 14), (2745, 17), (2762, 8), (2770, 4), (2774, 7), (2781, 29), (2810, 6), (2816, 18), (2834, 27), (2861, 20), (2881, 17), (2898, 19), (2917, 12), (2929, 40), (2969, 40), (3009, 12), (3021, 48), (3069, 25), (3094, 12), None, (3106, 8), (3114, 25), (3139, 19), (3158, 6), (3164, 23), None, (3187, 30), (3217, 33), (3250, 14), (3264, 12), (3276, 27), None, (3303, 26), (3329, 41), (3370, 50), (3420, 15), (3435, 20), (3455, 15), (3470, 21), (3491, 32), (3523, 24), (3547, 20), (3567, 17), (3584, 60), (3644, 19), (3663, 9), (3672, 12), (3684, 12), (3696, 11), (3707, 10), (3717, 48), (3765, 32), None, (3797, 25), (3822, 12), None, (3834, 8), (3842, 8), (3850, 7), None, (3857, 25), (3882, 17), None, (3899, 21), (3920, 35), (3955, 12), (3967, 10), (3977, 36), (4013, 20), (4033, 22), (4055, 23), (4078, 19), (4097, 12), (4109, 5), (4114, 30), (4144, 24), (4168, 14), (4182, 14), (4196, 47), (4243, 46), None, None, (4289, 51), (4340, 42), None, (4382, 14), None, (4396, 15), (4411, 8), (4419, 21), (4440, 6), (4446, 16), (4462, 17)], [(4479, 7012), (11491, 7434), (18925, 7722), (26647, 6727), (33374, 7121), (40495, 6785), (47280, 7666), (54946, 6744), (61690, 7559), (69249, 6726), (75975, 7951), (83926, 7003), (90929, 7174), (98103, 8236), (106339, 7088), (113427, 7364), (120791, 7663), (128454, 6525), (134979, 6923), (141902, 7078), (148980, 7557), (156537, 7201), (163738, 7584), (171322, 6752), (178074, 7287), (185361, 7121), (192482, 7533), (200015, 7707), (207722, 6983), (214705, 7305), (222010, 7659), (229669, 7108), (236777, 7232), (244009, 7606), (251615, 6800), (258415, 7356), (265771, 6943), (272714, 7768), (280482, 7376), (287858, 7512), (295370, 8112), (303482, 6990), (310472, 7094), (317566, 6768), (324334, 6975), (331309, 6971), (338280, 7122), (345402, 7863), (353265, 6979), (360244, 6745), (366989, 6969), (373958, 7411), (381369, 7430), (388799, 7496), (396295, 7806), (404101, 7508), (411609, 7440), (419049, 6914), (425963, 7711), (433674, 6493), (440167, 7271), (447438, 7057), (454495, 7128), (461623, 7731), (469354, 7537), (476891, 7553), (484444, 7016), (491460, 7927), (499387, 7603), (506990, 7418), (514408, 7073), (521481, 7098), (528579, 6501), (535080, 7618), (542698, 7620), (550318, 8010), (558328, 6712), (565040, 7955), (572995, 7761), (580756, 6790), (587546, 7562), (595108, 6391), (601499, 7127), (608626, 7384), (616010, 6941), (622951, 7073), (630024, 7551), (637575, 7330), (644905, 7471), (652376, 7462), (659838, 8150), (667988, 6573), (674561, 6978), (681539, 7164), (688703, 7351), (696054, 7770), (703824, 7752), (711576, 7016), (718592, 7022), (725614, 6903), (732517, 6920), (739437, 7392), (746829, 7186), (754015, 7138), (761153, 6956), (768109, 7653), (775762, 7535), (783297, 7650), (790947, 8627), (799574, 7727), (807301, 7500), (814801, 7303), (822104, 7102), (829206, 7187), (836393, 7594), (843987, 7450), (851437, 6984), (858421, 6953), (865374, 7006), (872380, 7783), (880163, 7689), (887852, 7603), (895455, 7620), (903075, 7670), (910745, 8419), (919164, 7051), (926215, 6599), (932814, 7664), (940478, 7337), (947815, 8801), (956616, 7984), (964600, 6818), (971418, 7593), (979011, 7450), (986461, 7014), (993475, 7559), (1001034, 6838), (1007872, 7339), (1015211, 7127), (1022338, 7207), (1029545, 7410), (1036955, 7749), (1044704, 6808), (1051512, 7205), (1058717, 7328), (1066045, 7199), (1073244, 7176), (1080420, 7316), (1087736, 6912), (1094648, 7864), (1102512, 7198), (1109710, 7568), (1117278, 7573), (1124851, 7066), (1131917, 7386), (1139303, 7334), (1146637, 7265), (1153902, 7136), (1161038, 6980), (1168018, 6675), (1174693, 6836), (1181529, 7542), (1189071, 8046), (1197117, 6797), (1203914, 7184), (1211098, 7793), (1218891, 7202), (1226093, 6988), (1233081, 7680), (1240761, 7226), (1247987, 6421), (1254408, 7204), (1261612, 8529), (1270141, 6701), (1276842, 7015), (1283857, 7496), (1291353, 7300), (1298653, 7302), (1305955, 7123), (1313078, 6778), (1319856, 8086), (1327942, 7506), (1335448, 7159), (1342607, 7774), (1350381, 8335), (1358716, 7914), (1366630, 6743), (1373373, 7706), (1381079, 6984), (1388063, 7367), (1395430, 7923), (1403353, 6984), (1410337, 7588), (1417925, 7708), (1425633, 7208), (1432841, 7223), (1440064, 7105), (1447169, 7214), (1454383, 7181), (1461564, 6971), (1468535, 7611), (1476146, 6617), (1482763, 7734), (1490497, 7456), (1497953, 7859), (1505812, 7634), (1513446, 6373), (1519819, 7353), (1527172, 7100), (1534272, 7559), (1541831, 7453), (1549284, 7735), (1557019, 7341), (1564360, 7802), (1572162, 7468), (1579630, 7239), (1586869, 7200), (1594069, 7145), (1601214, 7324), (1608538, 7241), (1615779, 7459), (1623238, 6714), (1629952, 8170), (1638122, 7253), (1645375, 6934), (1652309, 7276), (1659585, 7354), (1666939, 6738), (1673677, 7470), (1681147, 7240), (1688387, 8100), (1696487, 7364), (1703851, 6971), (1710822, 7548), (1718370, 7080), (1725450, 8043), (1733493, 7074), (1740567, 6937), (1747504, 6203), (1753707, 7800), (1761507, 7256), (1768763, 7480), (1776243, 7041), (1783284, 7234), (1790518, 7104), (1797622, 7745), (1805367, 7055), (1812422, 6510), (1818932, 7318), (1826250, 6795), (1833045, 7477), (1840522, 7648), (1848170, 7755), (1855925, 6863), (1862788, 7091), (1869879, 7290)], [(1877169, 831), (1878000, 715), (1878715, 688), (1879403, 896), (1880299, 624), (1880923, 715), (1881638, 671), (1882309, 910), (1883219, 705), (1883924, 717), (1884641, 580), (1885221, 657), (1885878, 792), (1886670, 885), (1887555, 1046), (1888601, 877), (1889478, 1270), (1890748, 686), (1891434, 956), (1892390, 804), (1893194, 766), (1893960, 810), (1894770, 946), (1895716, 692), (1896408, 776), (1897184, 715), (1897899, 1029), (1898928, 1266), (1900194, 780), (1900974, 822), (1901796, 1007), (1902803, 862), (1903665, 678), (1904343, 738), (1905081, 791), (1905872, 867), (1906739, 724), (1907463, 794), (1908257, 742), (1908999, 1133), (1910132, 695), (1910827, 810), (1911637, 794), (1912431, 753), (1913184, 762), (1913946, 473), (1914419, 1029), (1915448, 930), (1916378, 810), (1917188, 553), (1917741, 853), (1918594, 692), (1919286, 762), (1920048, 1048), (1921096, 1032), (1922128, 572), (1922700, 702), (1923402, 614), (1924016, 649), (1924665, 888), (1925553, 815), (1926368, 832), (1927200, 1073), (1928273, 981), (1929254, 819), (1930073, 758), (1930831, 804), (1931635, 472), (1932107, 667), (1932774, 620), (1933394, 751), (1934145, 928), (1935073, 652), (1935725, 791), (1936516, 650), (1937166, 745), (1937911, 688), (1938599, 689), (1939288, 828), (1940116, 511), (1940627, 843), (1941470, 687), (1942157, 874), (1943031, 700), (1943731, 673), (1944404, 480), (1944884, 657), (1945541, 801), (1946342, 885), (1947227, 802), (1948029, 924), (1948953, 1142), (1950095, 903), (1950998, 923), (1951921, 776), (1952697, 476), (1953173, 979), (1954152, 871), (1955023, 606), (1955629, 721), (1956350, 717), (1957067, 922), (1957989, 947), (1958936, 571), (1959507, 632), (1960139, 844), (1960983, 507), (1961490, 500), (1961990, 1028), (1963018, 1029), (1964047, 839), (1964886, 797), (1965683, 731), (1966414, 804), (1967218, 725), (1967943, 715), (1968658, 696), (1969354, 578), (1969932, 748), (1970680, 689), (1971369, 1026), (1972395, 756), (1973151, 830), (1973981, 502), (1974483, 691), (1975174, 828), (1976002, 880), (1976882, 944), (1977826, 782), (1978608, 990), (1979598, 832), (1980430, 594), (1981024, 892), (1981916, 718), (1982634, 849), (1983483, 795), (1984278, 736), (1985014, 725), (1985739, 688), (1986427, 644), (1987071, 670), (1987741, 701), (1988442, 809), (1989251, 614), (1989865, 517), (1990382, 603), (1990985, 676), (1991661, 632), (1992293, 797), (1993090, 688), (1993778, 789), (1994567, 566), (1995133, 550), (1995683, 750), (1996433, 742), (1997175, 692), (1997867, 685), (1998552, 975), (1999527, 699), (2000226, 576), (2000802, 1022), (2001824, 913), (2002737, 620), (2003357, 750), (2004107, 872), (2004979, 714), (2005693, 707), (2006400, 546), (2006946, 690), (2007636, 749), (2008385, 830), (2009215, 670), (2009885, 932), (2010817, 804), (2011621, 863), (2012484, 796), (2013280, 707), (2013987, 616), (2014603, 735), (2015338, 739), (2016077, 1464), (2017541, 577), (2018118, 712), (2018830, 717), (2019547, 1043), (2020590, 853), (2021443, 848), (2022291, 621), (2022912, 644), (2023556, 904), (2024460, 623), (2025083, 603), (2025686, 831), (2026517, 743), (2027260, 937), (2028197, 822), (2029019, 761), (2029780, 764), (2030544, 883), (2031427, 690), (2032117, 977), (2033094, 680), (2033774, 842), (2034616, 618), (2035234, 805), (2036039, 591), (2036630, 863), (2037493, 843), (2038336, 724), (2039060, 963), (2040023, 761), (2040784, 860), (2041644, 942), (2042586, 1115), (2043701, 922), (2044623, 700), (2045323, 1020), (2046343, 772), (2047115, 589), (2047704, 476), (2048180, 860), (2049040, 806), (2049846, 506), (2050352, 1064), (2051416, 582), (2051998, 798), (2052796, 924), (2053720, 878), (2054598, 872), (2055470, 722), (2056192, 840), (2057032, 783), (2057815, 865), (2058680, 604), (2059284, 665), (2059949, 499), (2060448, 703), (2061151, 484), (2061635, 799), (2062434, 889), (2063323, 881), (2064204, 718), (2064922, 675), (2065597, 604), (2066201, 965), (2067166, 523), (2067689, 629), (2068318, 848), (2069166, 535), (2069701, 923), (2070624, 2112), (2072736, 677), (2073413, 726), (2074139, 938), (2075077, 1049), (2076126, 557)], [(2076683, 48), None, (2076731, 35), (2076766, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2076808, 42), None, (2076850, 25), (2076875, 44), (2076919, 22), (2076941, 18), None, None, None, None, (2076959, 26), None, None, None, None, (2076985, 21), (2077006, 25), None, None, (2077031, 26), None, None, None, None, (2077057, 44), (2077101, 21), (2077122, 23), None, None, None, None, (2077145, 48), None, None, None, None, None, (2077193, 31), None, None, None, None, (2077224, 42), None, (2077266, 22), None, (2077288, 21), None, (2077309, 26), (2077335, 42), None, None, (2077377, 77), None, None, None, None, None, (2077454, 21), (2077475, 21), None, None, (2077496, 34), (2077530, 42), None, None, None, (2077572, 25), None, None, (2077597, 21), None, None, None, None, None, (2077618, 24), (2077642, 21), None, None, (2077663, 26), None, (2077689, 18), None, (2077707, 54), None, None, None, None, None, None, (2077761, 26), None, (2077787, 19), None, (2077806, 20), None, None, (2077826, 42), (2077868, 42), (2077910, 17), (2077927, 17), (2077944, 26), None, (2077970, 26), None, None, None, (2077996, 26), (2078022, 20), (2078042, 26), None, (2078068, 42), (2078110, 63), None, None, None, (2078173, 40), (2078213, 48), None, None, None, (2078261, 47), None, None, None, None, None, None, None, (2078308, 42), None, (2078350, 55), None, (2078405, 9), None, (2078414, 21), (2078435, 42), None, None, (2078477, 65), (2078542, 82), None, None, (2078624, 42), None, None, None, None, None, None, None, None, None, (2078666, 42), (2078708, 21), (2078729, 21), None, (2078750, 42), (2078792, 25), None, (2078817, 16), (2078833, 21), (2078854, 56), None, None, (2078910, 21), (2078931, 19), (2078950, 26), None, (2078976, 16), None, (2078992, 39), None, None, (2079031, 38), None, (2079069, 22), (2079091, 21), (2079112, 21), None, None, (2079133, 63), None, (2079196, 21), (2079217, 42), None, (2079259, 17), None, None, None, None, (2079276, 21), (2079297, 21), None, None, (2079318, 21), None, None, (2079339, 21), None, (2079360, 26), None, (2079386, 50), None, None, None, (2079436, 50), (2079486, 26), (2079512, 21), (2079533, 21), (2079554, 19), None, (2079573, 35), (2079608, 26), (2079634, 23), (2079657, 21), (2079678, 42), None, None, None, None, None, None, (2079720, 21), None, None, None, (2079741, 21), None, None, (2079762, 90), None, (2079852, 239), (2080091, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
