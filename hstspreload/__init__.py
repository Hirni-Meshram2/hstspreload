"""Check if a host is in the Google Chrome HSTS Preload list"""

import functools
import os
import typing

__version__ = "2021.3.29"
__checksum__ = "918f12187569f7be9911f5a45c14bffff21cf37b1a89f2f1a59fa57b9f093ab9"
__all__ = ["in_hsts_preload"]

# fmt: off
_GTLD_INCLUDE_SUBDOMAINS = {b'android', b'app', b'bank', b'chrome', b'dev', b'foo', b'gle', b'gmail', b'google', b'hangout', b'insurance', b'meet', b'new', b'page', b'play', b'search', b'youtube'}  # noqa: E501
_JUMPTABLE = [[(0, 11), (11, 5), (16, 9), (25, 61), (86, 26), (112, 12), None, (124, 19), (143, 22), (165, 7), (172, 20), (192, 18), None, (210, 29), (239, 45), (284, 7), (291, 9), (300, 36), (336, 10), (346, 10), (356, 28), None, (384, 54), (438, 8), (446, 18), (464, 19), (483, 13), (496, 14), (510, 14), None, None, (524, 29), (553, 20), (573, 35), (608, 14), (622, 24), (646, 9), None, (655, 25), (680, 27), (707, 8), (715, 13), None, None, (728, 17), (745, 6), (751, 26), (777, 5), (782, 5), (787, 10), (797, 14), (811, 11), (822, 12), (834, 27), None, (861, 11), (872, 11), (883, 7), (890, 29), (919, 18), (937, 27), (964, 46), (1010, 25), (1035, 16), (1051, 8), (1059, 5), (1064, 22), (1086, 18), None, (1104, 36), (1140, 15), (1155, 8), (1163, 11), None, (1174, 5), (1179, 16), (1195, 14), (1209, 18), None, (1227, 14), (1241, 26), (1267, 48), (1315, 19), (1334, 5), (1339, 46), (1385, 14), (1399, 14), (1413, 20), None, (1433, 10), (1443, 13), (1456, 15), (1471, 19), None, (1490, 13), (1503, 19), (1522, 11), (1533, 4), (1537, 22), (1559, 10), (1569, 7), (1576, 14), (1590, 21), (1611, 11), (1622, 21), (1643, 12), (1655, 32), None, (1687, 10), (1697, 14), (1711, 12), (1723, 45), (1768, 15), None, (1783, 11), (1794, 23), (1817, 21), (1838, 26), (1864, 6), (1870, 6), (1876, 7), (1883, 5), (1888, 20), (1908, 23), (1931, 24), (1955, 13), (1968, 15), (1983, 19), (2002, 6), (2008, 61), (2069, 44), (2113, 12), (2125, 23), (2148, 16), (2164, 38), (2202, 6), (2208, 12), (2220, 44), (2264, 6), (2270, 41), (2311, 13), (2324, 23), (2347, 30), (2377, 16), (2393, 8), (2401, 15), (2416, 12), (2428, 19), (2447, 21), (2468, 15), None, (2483, 35), (2518, 21), (2539, 17), (2556, 19), (2575, 26), (2601, 5), (2606, 37), (2643, 26), (2669, 16), (2685, 10), (2695, 17), (2712, 23), (2735, 14), (2749, 17), (2766, 8), (2774, 4), (2778, 7), (2785, 29), (2814, 6), (2820, 18), (2838, 27), (2865, 20), (2885, 17), (2902, 19), (2921, 12), (2933, 40), (2973, 40), (3013, 12), (3025, 48), (3073, 25), (3098, 12), None, (3110, 8), (3118, 25), (3143, 19), (3162, 6), (3168, 23), None, (3191, 30), (3221, 33), (3254, 14), (3268, 12), (3280, 27), None, (3307, 26), (3333, 41), (3374, 50), (3424, 15), (3439, 20), (3459, 15), (3474, 21), (3495, 32), (3527, 24), (3551, 20), (3571, 17), (3588, 60), (3648, 19), (3667, 9), (3676, 12), (3688, 12), (3700, 11), (3711, 10), (3721, 48), (3769, 32), None, (3801, 25), (3826, 23), None, (3849, 8), (3857, 8), (3865, 7), None, (3872, 25), (3897, 17), None, (3914, 21), (3935, 35), (3970, 21), (3991, 10), (4001, 36), (4037, 20), (4057, 22), (4079, 23), (4102, 19), (4121, 12), (4133, 5), (4138, 30), (4168, 24), (4192, 14), (4206, 14), (4220, 47), (4267, 46), None, None, (4313, 51), (4364, 42), None, (4406, 14), None, (4420, 15), (4435, 8), (4443, 21), (4464, 6), (4470, 16), (4486, 17)], [(4503, 7384), (11887, 7907), (19794, 8192), (27986, 7090), (35076, 7535), (42611, 7044), (49655, 8191), (57846, 7040), (64886, 7957), (72843, 7319), (80162, 8565), (88727, 7310), (96037, 7776), (103813, 8887), (112700, 7598), (120298, 7710), (128008, 8241), (136249, 7053), (143302, 7475), (150777, 7318), (158095, 7903), (165998, 7780), (173778, 8129), (181907, 7209), (189116, 7646), (196762, 7567), (204329, 8088), (212417, 8165), (220582, 7508), (228090, 7504), (235594, 7957), (243551, 7660), (251211, 7593), (258804, 7957), (266761, 7248), (274009, 7727), (281736, 7481), (289217, 8321), (297538, 7959), (305497, 8078), (313575, 8541), (322116, 7347), (329463, 7454), (336917, 7290), (344207, 7441), (351648, 7413), (359061, 7707), (366768, 8455), (375223, 7467), (382690, 7065), (389755, 7322), (397077, 7984), (405061, 7962), (413023, 8008), (421031, 8208), (429239, 7780), (437019, 8022), (445041, 7544), (452585, 8222), (460807, 6765), (467572, 7644), (475216, 7836), (483052, 7482), (490534, 8224), (498758, 8083), (506841, 8058), (514899, 7301), (522200, 8236), (530436, 8061), (538497, 7855), (546352, 7533), (553885, 7387), (561272, 7007), (568279, 8156), (576435, 7980), (584415, 8399), (592814, 7294), (600108, 8363), (608471, 8170), (616641, 7166), (623807, 8025), (631832, 6830), (638662, 7652), (646314, 7797), (654111, 7355), (661466, 7642), (669108, 8140), (677248, 7882), (685130, 7998), (693128, 7913), (701041, 8612), (709653, 7053), (716706, 7614), (724320, 7762), (732082, 7984), (740066, 8396), (748462, 8254), (756716, 7365), (764081, 7480), (771561, 7506), (779067, 7495), (786562, 7765), (794327, 7661), (801988, 7531), (809519, 7334), (816853, 8204), (825057, 8113), (833170, 8106), (841276, 8950), (850226, 8154), (858380, 7948), (866328, 7972), (874300, 7464), (881764, 7550), (889314, 7925), (897239, 7934), (905173, 7469), (912642, 7381), (920023, 7553), (927576, 8423), (935999, 8133), (944132, 8039), (952171, 7871), (960042, 8191), (968233, 9073), (977306, 7602), (984908, 7065), (991973, 8192), (1000165, 7758), (1007923, 9464), (1017387, 8369), (1025756, 7337), (1033093, 8026), (1041119, 7894), (1049013, 7325), (1056338, 8143), (1064481, 7537), (1072018, 8010), (1080028, 7557), (1087585, 7836), (1095421, 7838), (1103259, 8163), (1111422, 7241), (1118663, 7512), (1126175, 7752), (1133927, 7553), (1141480, 7617), (1149097, 7610), (1156707, 7377), (1164084, 8284), (1172368, 7822), (1180190, 7951), (1188141, 8086), (1196227, 7396), (1203623, 7801), (1211424, 7692), (1219116, 7635), (1226751, 7703), (1234454, 7498), (1241952, 7108), (1249060, 7257), (1256317, 8074), (1264391, 8430), (1272821, 7376), (1280197, 7521), (1287718, 8377), (1296095, 7647), (1303742, 7201), (1310943, 8059), (1319002, 7857), (1326859, 6894), (1333753, 7735), (1341488, 9103), (1350591, 7155), (1357746, 7288), (1365034, 8013), (1373047, 7645), (1380692, 7894), (1388586, 7464), (1396050, 7259), (1403309, 8597), (1411906, 8115), (1420021, 7677), (1427698, 8217), (1435915, 8739), (1444654, 8422), (1453076, 7169), (1460245, 8134), (1468379, 7495), (1475874, 7801), (1483675, 8330), (1492005, 7408), (1499413, 8062), (1507475, 8047), (1515522, 7572), (1523094, 7720), (1530814, 7523), (1538337, 7808), (1546145, 7551), (1553696, 7324), (1561020, 8063), (1569083, 7311), (1576394, 8223), (1584617, 7942), (1592559, 8221), (1600780, 8159), (1608939, 6926), (1615865, 7965), (1623830, 7533), (1631363, 7999), (1639362, 8040), (1647402, 8147), (1655549, 7765), (1663314, 8141), (1671455, 8003), (1679458, 7523), (1686981, 7730), (1694711, 7558), (1702269, 7841), (1710110, 7979), (1718089, 7776), (1725865, 7192), (1733057, 8710), (1741767, 7731), (1749498, 7349), (1756847, 7746), (1764593, 7761), (1772354, 7130), (1779484, 8025), (1787509, 7703), (1795212, 8480), (1803692, 7931), (1811623, 7459), (1819082, 8049), (1827131, 7771), (1834902, 8537), (1843439, 7491), (1850930, 7380), (1858310, 6739), (1865049, 8200), (1873249, 7876), (1881125, 8156), (1889281, 7542), (1896823, 7910), (1904733, 7545), (1912278, 8266), (1920544, 7531), (1928075, 6991), (1935066, 7666), (1942732, 7288), (1950020, 7933), (1957953, 8161), (1966114, 8216), (1974330, 7456), (1981786, 7592), (1989378, 7758)], [(1997136, 933), (1998069, 715), (1998784, 754), (1999538, 918), (2000456, 638), (2001094, 785), (2001879, 671), (2002550, 970), (2003520, 721), (2004241, 729), (2004970, 580), (2005550, 660), (2006210, 804), (2007014, 885), (2007899, 1022), (2008921, 908), (2009829, 1336), (2011165, 736), (2011901, 960), (2012861, 836), (2013697, 766), (2014463, 811), (2015274, 946), (2016220, 765), (2016985, 799), (2017784, 715), (2018499, 1050), (2019549, 1266), (2020815, 797), (2021612, 853), (2022465, 1037), (2023502, 880), (2024382, 673), (2025055, 773), (2025828, 864), (2026692, 848), (2027540, 822), (2028362, 799), (2029161, 777), (2029938, 1087), (2031025, 713), (2031738, 866), (2032604, 816), (2033420, 784), (2034204, 805), (2035009, 522), (2035531, 1086), (2036617, 1027), (2037644, 847), (2038491, 596), (2039087, 882), (2039969, 706), (2040675, 762), (2041437, 1065), (2042502, 1046), (2043548, 572), (2044120, 702), (2044822, 697), (2045519, 683), (2046202, 888), (2047090, 850), (2047940, 832), (2048772, 1135), (2049907, 1038), (2050945, 793), (2051738, 793), (2052531, 790), (2053321, 495), (2053816, 679), (2054495, 633), (2055128, 803), (2055931, 985), (2056916, 675), (2057591, 837), (2058428, 664), (2059092, 786), (2059878, 705), (2060583, 725), (2061308, 843), (2062151, 553), (2062704, 875), (2063579, 724), (2064303, 929), (2065232, 700), (2065932, 739), (2066671, 482), (2067153, 669), (2067822, 817), (2068639, 908), (2069547, 809), (2070356, 1024), (2071380, 1203), (2072583, 919), (2073502, 941), (2074443, 817), (2075260, 476), (2075736, 996), (2076732, 871), (2077603, 675), (2078278, 721), (2078999, 800), (2079799, 934), (2080733, 966), (2081699, 619), (2082318, 652), (2082970, 901), (2083871, 507), (2084378, 541), (2084919, 1018), (2085937, 1045), (2086982, 802), (2087784, 825), (2088609, 803), (2089412, 780), (2090192, 767), (2090959, 753), (2091712, 696), (2092408, 597), (2093005, 787), (2093792, 707), (2094499, 1095), (2095594, 772), (2096366, 821), (2097187, 502), (2097689, 741), (2098430, 868), (2099298, 880), (2100178, 1026), (2101204, 767), (2101971, 1017), (2102988, 873), (2103861, 635), (2104496, 939), (2105435, 733), (2106168, 891), (2107059, 795), (2107854, 720), (2108574, 690), (2109264, 719), (2109983, 649), (2110632, 723), (2111355, 701), (2112056, 824), (2112880, 651), (2113531, 562), (2114093, 620), (2114713, 731), (2115444, 650), (2116094, 790), (2116884, 702), (2117586, 823), (2118409, 586), (2118995, 644), (2119639, 789), (2120428, 723), (2121151, 713), (2121864, 784), (2122648, 988), (2123636, 760), (2124396, 614), (2125010, 1044), (2126054, 892), (2126946, 696), (2127642, 765), (2128407, 918), (2129325, 736), (2130061, 745), (2130806, 623), (2131429, 755), (2132184, 769), (2132953, 854), (2133807, 677), (2134484, 950), (2135434, 819), (2136253, 904), (2137157, 833), (2137990, 737), (2138727, 630), (2139357, 813), (2140170, 840), (2141010, 1552), (2142562, 594), (2143156, 837), (2143993, 710), (2144703, 1008), (2145711, 864), (2146575, 870), (2147445, 653), (2148098, 674), (2148772, 941), (2149713, 623), (2150336, 603), (2150939, 873), (2151812, 784), (2152596, 948), (2153544, 825), (2154369, 810), (2155179, 781), (2155960, 915), (2156875, 731), (2157606, 982), (2158588, 715), (2159303, 879), (2160182, 618), (2160800, 823), (2161623, 605), (2162228, 946), (2163174, 914), (2164088, 764), (2164852, 1024), (2165876, 761), (2166637, 906), (2167543, 999), (2168542, 1131), (2169673, 952), (2170625, 788), (2171413, 1020), (2172433, 830), (2173263, 589), (2173852, 495), (2174347, 893), (2175240, 794), (2176034, 542), (2176576, 1083), (2177659, 556), (2178215, 798), (2179013, 953), (2179966, 916), (2180882, 908), (2181790, 746), (2182536, 933), (2183469, 763), (2184232, 898), (2185130, 619), (2185749, 700), (2186449, 519), (2186968, 703), (2187671, 486), (2188157, 878), (2189035, 962), (2189997, 881), (2190878, 718), (2191596, 675), (2192271, 674), (2192945, 995), (2193940, 523), (2194463, 638), (2195101, 935), (2196036, 519), (2196555, 962), (2197517, 2131), (2199648, 714), (2200362, 749), (2201111, 975), (2202086, 1094), (2203180, 515)], [(2203695, 48), None, (2203743, 35), (2203778, 42), None, None, None, None, None, None, None, None, None, None, None, None, None, (2203820, 42), None, (2203862, 25), (2203887, 44), (2203931, 22), (2203953, 18), None, None, None, None, (2203971, 26), None, None, None, None, (2203997, 21), (2204018, 25), None, None, (2204043, 26), None, None, None, None, (2204069, 71), (2204140, 21), (2204161, 23), None, None, None, None, (2204184, 48), None, None, None, None, None, (2204232, 31), None, None, None, None, (2204263, 42), None, (2204305, 22), None, (2204327, 21), None, (2204348, 26), (2204374, 42), None, None, (2204416, 77), None, None, None, None, None, (2204493, 21), (2204514, 21), None, None, (2204535, 34), (2204569, 42), None, None, None, (2204611, 25), None, None, (2204636, 21), None, None, None, None, None, (2204657, 24), (2204681, 21), None, None, (2204702, 26), None, (2204728, 18), None, (2204746, 54), None, None, None, None, None, None, (2204800, 26), None, None, None, (2204826, 20), None, None, (2204846, 42), (2204888, 42), (2204930, 17), (2204947, 17), (2204964, 26), None, (2204990, 26), None, None, None, (2205016, 26), (2205042, 20), (2205062, 26), None, (2205088, 42), (2205130, 63), None, None, None, (2205193, 40), (2205233, 48), None, None, None, (2205281, 47), None, None, None, None, None, None, None, (2205328, 42), None, (2205370, 80), None, (2205450, 9), None, (2205459, 21), (2205480, 42), None, None, (2205522, 65), (2205587, 82), None, None, (2205669, 42), None, None, None, (2205711, 21), None, None, None, None, None, (2205732, 42), (2205774, 21), (2205795, 21), None, (2205816, 42), (2205858, 25), None, (2205883, 16), (2205899, 21), (2205920, 56), None, None, (2205976, 21), (2205997, 19), (2206016, 26), None, (2206042, 16), None, (2206058, 21), None, None, (2206079, 38), None, (2206117, 22), (2206139, 21), (2206160, 21), (2206181, 21), None, (2206202, 63), None, (2206265, 21), (2206286, 42), None, (2206328, 17), None, None, None, None, (2206345, 21), (2206366, 21), None, None, (2206387, 21), None, None, (2206408, 21), None, (2206429, 26), None, (2206455, 50), None, None, None, (2206505, 50), (2206555, 26), (2206581, 21), (2206602, 21), (2206623, 19), None, (2206642, 35), (2206677, 26), (2206703, 23), (2206726, 39), (2206765, 42), None, None, None, None, None, None, (2206807, 21), None, None, None, (2206828, 21), None, None, (2206849, 90), None, (2206939, 239), (2207178, 38), None, None, None, None]]  # noqa: E501
_CRC8_TABLE = [
    0x00, 0x07, 0x0e, 0x09, 0x1c, 0x1b, 0x12, 0x15,
    0x38, 0x3f, 0x36, 0x31, 0x24, 0x23, 0x2a, 0x2d,
    0x70, 0x77, 0x7e, 0x79, 0x6c, 0x6b, 0x62, 0x65,
    0x48, 0x4f, 0x46, 0x41, 0x54, 0x53, 0x5a, 0x5d,
    0xe0, 0xe7, 0xee, 0xe9, 0xfc, 0xfb, 0xf2, 0xf5,
    0xd8, 0xdf, 0xd6, 0xd1, 0xc4, 0xc3, 0xca, 0xcd,
    0x90, 0x97, 0x9e, 0x99, 0x8c, 0x8b, 0x82, 0x85,
    0xa8, 0xaf, 0xa6, 0xa1, 0xb4, 0xb3, 0xba, 0xbd,
    0xc7, 0xc0, 0xc9, 0xce, 0xdb, 0xdc, 0xd5, 0xd2,
    0xff, 0xf8, 0xf1, 0xf6, 0xe3, 0xe4, 0xed, 0xea,
    0xb7, 0xb0, 0xb9, 0xbe, 0xab, 0xac, 0xa5, 0xa2,
    0x8f, 0x88, 0x81, 0x86, 0x93, 0x94, 0x9d, 0x9a,
    0x27, 0x20, 0x29, 0x2e, 0x3b, 0x3c, 0x35, 0x32,
    0x1f, 0x18, 0x11, 0x16, 0x03, 0x04, 0x0d, 0x0a,
    0x57, 0x50, 0x59, 0x5e, 0x4b, 0x4c, 0x45, 0x42,
    0x6f, 0x68, 0x61, 0x66, 0x73, 0x74, 0x7d, 0x7a,
    0x89, 0x8e, 0x87, 0x80, 0x95, 0x92, 0x9b, 0x9c,
    0xb1, 0xb6, 0xbf, 0xb8, 0xad, 0xaa, 0xa3, 0xa4,
    0xf9, 0xfe, 0xf7, 0xf0, 0xe5, 0xe2, 0xeb, 0xec,
    0xc1, 0xc6, 0xcf, 0xc8, 0xdd, 0xda, 0xd3, 0xd4,
    0x69, 0x6e, 0x67, 0x60, 0x75, 0x72, 0x7b, 0x7c,
    0x51, 0x56, 0x5f, 0x58, 0x4d, 0x4a, 0x43, 0x44,
    0x19, 0x1e, 0x17, 0x10, 0x05, 0x02, 0x0b, 0x0c,
    0x21, 0x26, 0x2f, 0x28, 0x3d, 0x3a, 0x33, 0x34,
    0x4e, 0x49, 0x40, 0x47, 0x52, 0x55, 0x5c, 0x5b,
    0x76, 0x71, 0x78, 0x7f, 0x6a, 0x6d, 0x64, 0x63,
    0x3e, 0x39, 0x30, 0x37, 0x22, 0x25, 0x2c, 0x2b,
    0x06, 0x01, 0x08, 0x0f, 0x1a, 0x1d, 0x14, 0x13,
    0xae, 0xa9, 0xa0, 0xa7, 0xb2, 0xb5, 0xbc, 0xbb,
    0x96, 0x91, 0x98, 0x9f, 0x8a, 0x8d, 0x84, 0x83,
    0xde, 0xd9, 0xd0, 0xd7, 0xc2, 0xc5, 0xcc, 0xcb,
    0xe6, 0xe1, 0xe8, 0xef, 0xfa, 0xfd, 0xf4, 0xf3
]
# fmt: on

_IS_LEAF = 0x80
_INCLUDE_SUBDOMAINS = 0x40


try:
    from importlib.resources import open_binary

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open_binary("hstspreload", path)


except ImportError:

    def open_pkg_binary(path: str) -> typing.BinaryIO:
        return open(
            os.path.join(os.path.dirname(os.path.abspath(__file__)), path),
            "rb",
        )


@functools.lru_cache(maxsize=1024)
def in_hsts_preload(host: typing.AnyStr) -> bool:
    """Determines if an IDNA-encoded host is on the HSTS preload list"""

    if isinstance(host, str):
        host = host.encode("ascii")
    labels = host.lower().split(b".")

    # Fast-branch for gTLDs that are registered to preload all sub-domains.
    if labels[-1] in _GTLD_INCLUDE_SUBDOMAINS:
        return True

    with open_pkg_binary("hstspreload.bin") as f:
        for layer, label in enumerate(labels[::-1]):
            # None of our layers are greater than 4 deep.
            if layer > 3:
                return False

            # Read the jump table for the layer and label
            jump_info = _JUMPTABLE[layer][_crc8(label)]
            if jump_info is None:
                # No entry: host is not preloaded
                return False

            # Read the set of entries for that layer and label
            f.seek(jump_info[0])
            data = bytearray(jump_info[1])
            f.readinto(data)

            for is_leaf, include_subdomains, ent_label in _iter_entries(data):
                # We found a potential leaf
                if is_leaf:
                    if ent_label == host:
                        return True
                    if include_subdomains and host.endswith(b"." + ent_label):
                        return True

                # Continue traversing as we're not at a leaf.
                elif label == ent_label:
                    break
            else:
                return False
    return False


def _iter_entries(data: bytes) -> typing.Iterable[typing.Tuple[int, int, bytes]]:
    while data:
        flags = data[0]
        size = data[1]
        label = bytes(data[2 : 2 + size])
        yield (flags & _IS_LEAF, flags & _INCLUDE_SUBDOMAINS, label)
        data = data[2 + size :]


def _crc8(value: bytes) -> int:
    # CRC8 reference implementation: https://github.com/niccokunzmann/crc8
    checksum = 0x00
    for byte in value:
        checksum = _CRC8_TABLE[checksum ^ byte]
    return checksum
